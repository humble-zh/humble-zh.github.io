<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>linux网络3_gre | Zhihong&#39;s Blog</title>
    <meta name="author" content="Zhihong Li" />
    <meta name="keywords" content="zhbox" />
    <meta name="description" content="拓扑配置gre123456#routerBremoteip=30.1.1.2localip=30.1.1.1greip=10.10.10.1grepeerip=10.10.10.2grename=gre1123456#routerAremoteip=30.1.1.1localip=30.1.1.2greip=10.10.10.2grepeerip=10.10.10.1grename=gre1123456789#routerB and routerAlsmod|grep ip_gre || mod" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Zhihong&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Zhihong&#39;s Blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/zhbox">
                <span class="nav-text">中盒</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://humble-zh.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E6%89%91"><span class="toc-number">1.</span> <span class="toc-text">拓扑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEgre"><span class="toc-number">2.</span> <span class="toc-text">配置gre</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%9A%A7%E9%81%93%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.</span> <span class="toc-text">测试隧道连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-number">4.</span> <span class="toc-text">配置路由表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%A7%81%E7%BD%91%E5%92%8C%E9%9A%A7%E9%81%93"><span class="toc-number">5.</span> <span class="toc-text">测试私网和隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%9A%A7%E9%81%93"><span class="toc-number">6.</span> <span class="toc-text">删除隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TODO-%E5%88%9B%E5%BB%BA%E5%A4%9A%E4%B8%AA%E9%9A%A7%E9%81%93"><span class="toc-number">7.</span> <span class="toc-text">TODO 创建多个隧道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%9D%E5%A4%96%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">额外问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">9.</span> <span class="toc-text">调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%93%E5%8D%B0"><span class="toc-number">9.1.</span> <span class="toc-text">代码打印</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">9.2.</span> <span class="toc-text">编译加载模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%9B%B4%E8%BF%9E%E6%97%B6"><span class="toc-number">9.3.</span> <span class="toc-text">设备直连时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%B7%A8%E7%BD%91%E6%AE%B5%E6%97%B6"><span class="toc-number">9.4.</span> <span class="toc-text">测试跨网段时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">9.5.</span> <span class="toc-text">结论</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            linux网络3_gre
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-10-12T01:32:41.000Z" itemprop="datePublished">2021-10-12</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/gre/" rel="tag">gre</a>, <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h2><p><img src="/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/gre%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<h2 id="配置gre"><a href="#配置gre" class="headerlink" title="配置gre"></a>配置gre</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerB</span></span><br><span class="line">remoteip=30.1.1.2</span><br><span class="line">localip=30.1.1.1</span><br><span class="line">greip=10.10.10.1</span><br><span class="line">grepeerip=10.10.10.2</span><br><span class="line">grename=gre1</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerA</span></span><br><span class="line">remoteip=30.1.1.1</span><br><span class="line">localip=30.1.1.2</span><br><span class="line">greip=10.10.10.2</span><br><span class="line">grepeerip=10.10.10.1</span><br><span class="line">grename=gre1</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerB and routerA</span></span><br><span class="line">lsmod|grep ip_gre || modprobe ip_gre</span><br><span class="line">ping -c1 <span class="variable">$&#123;remoteip&#125;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;make sure the network is ok plz&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">ip addr show <span class="variable">$&#123;grename&#125;</span> &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;grename&#125;</span> is already exist&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line">ip tunnel add <span class="variable">$&#123;grename&#125;</span> mode gre remote <span class="variable">$&#123;remoteip&#125;</span> <span class="built_in">local</span> <span class="variable">$&#123;localip&#125;</span> ikey 1 okey 1 ttl 255;</span><br><span class="line">ip addr add <span class="variable">$&#123;greip&#125;</span> dev <span class="variable">$&#123;grename&#125;</span> peer <span class="variable">$&#123;grepeerip&#125;</span>;</span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;grename&#125;</span> up; <span class="comment">#mtu 1400</span></span><br><span class="line">ip addr show <span class="variable">$&#123;grename&#125;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="测试隧道连接"><a href="#测试隧道连接" class="headerlink" title="测试隧道连接"></a>测试隧道连接</h2><p>routerB <code>ping -I 10.10.10.1 10.10.10.2 -c2</code> 通路<br>routerA <code>ping -I 10.10.10.2 10.10.10.1 -c2</code> 通路</p>
<h2 id="配置路由表"><a href="#配置路由表" class="headerlink" title="配置路由表"></a>配置路由表</h2><p>routeB <code>ip route add 10.2.1.0/24 via 10.10.10.2</code><br>routeA <code>ip route add 10.1.1.0/24 via 10.10.10.1</code></p>
<h2 id="测试私网和隧道"><a href="#测试私网和隧道" class="headerlink" title="测试私网和隧道"></a>测试私网和隧道</h2><p>PC2 <code>ping 10.2.1.2</code> 通路<br>PC1 <code>ping 10.1.1.2</code> 通路</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [11:37:33]</span></span><br><span class="line">$ tcpdump -nvvvi gre1</span><br><span class="line">tcpdump: listening on gre1, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">12:31:30.309857 IP (tos 0x0, ttl 63, id 59102, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    10.10.10.1 &gt; 10.2.1.2: ICMP <span class="built_in">echo</span> request, id 6, seq 1, length 64</span><br><span class="line">12:31:30.310258 IP (tos 0x0, ttl 63, id 17143, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.2.1.2 &gt; 10.10.10.1: ICMP <span class="built_in">echo</span> reply, id 6, seq 1, length 64</span><br></pre></td></tr></table></figure>
<h2 id="删除隧道"><a href="#删除隧道" class="headerlink" title="删除隧道"></a>删除隧道</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> gre1 down</span><br><span class="line">ip tunnel del gre1</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">## 卸载模块</span></span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line">rmmod ip_gre</span><br></pre></td></tr></table></figure>
<h2 id="TODO-创建多个隧道"><a href="#TODO-创建多个隧道" class="headerlink" title="TODO 创建多个隧道"></a>TODO 创建多个隧道</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhanzc1/article/details/80399337">两台设备之间建立多条gre通道</a></p>
<h2 id="额外问题"><a href="#额外问题" class="headerlink" title="额外问题"></a>额外问题</h2><ol>
<li><p>查看内核是否支持gre</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep GRE /boot/config-$(uname -r)</span><br><span class="line">sysctl net.netfilter.nf_conntrack_helper=1</span><br></pre></td></tr></table></figure></li>
<li><p><code>kernel: conntrack: generic helper won&#39;t handle protocol 47. Please consider loading the specific helper module.</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe nf_conntrack_proto_gre</span><br></pre></td></tr></table></figure></li>
<li><p>若需要<code>grep nf_nat_proto_gre || modprobe nf_nat_proto_gre</code></p>
</li>
<li><p>GRE是将一个数据包封装到另一个数据包中，因此你可能会遇到GRE的数据报大于网络接口所设定的数据包最大尺寸的情况。解决这种问题的方法是在隧道接口上配置ip tcp adjust-mss 1436。另外，虽然GRE并不支持加密，但是你可以通过tunnel key命令在隧道的两头各设置一个密钥。这个密钥其实就是一个明文的密码。或者使用gre over ipsec，那样就比较复杂了再另说。</p>
</li>
<li><p>GRE隧道没有状态控制，可能隧道的一端已经关闭，而另一端仍然开启。这一问题的解决方案就是在隧道两端开启keepalive数据包。它可以让隧道一端定时向另一端发送keepalive数据，确认端口保持开启状态。如果隧道的某一端没有按时收到keepalive数据，那么这一侧的隧道端口 也会关闭。</p>
</li>
</ol>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="代码打印"><a href="#代码打印" class="headerlink" title="代码打印"></a>代码打印</h3><p><code>kernel/net/ipv4/ip_gre.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ipgre_rcv</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct tnl_ptk_info *tpi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> dev_net(skb-&gt;dev);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">metadata_dst</span> *<span class="title">tun_dst</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel_net</span> *<span class="title">itn</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel</span> *<span class="title">tunnel</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> sip[<span class="number">18</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> dip[<span class="number">18</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;ipgre_rcv\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (tpi-&gt;proto == htons(ETH_P_TEB))&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;tpi-&gt;proto == htons(ETH_P_TEB)\n&quot;</span>);</span><br><span class="line">        itn = net_generic(net, gre_tap_net_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;tpi-&gt;proto != htons(ETH_P_TEB)\n&quot;</span>);</span><br><span class="line">        itn = net_generic(net, ipgre_net_id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iph = ip_hdr(skb);</span><br><span class="line">    <span class="keyword">if</span>(iph != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        p = (<span class="keyword">char</span> *) &amp;iph-&gt;saddr;</span><br><span class="line">        <span class="built_in">sprintf</span>(sip, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, (p[<span class="number">0</span>] &amp; <span class="number">255</span>), (p[<span class="number">1</span>] &amp; <span class="number">255</span>), (p[<span class="number">2</span>] &amp; <span class="number">255</span>), (p[<span class="number">3</span>] &amp; <span class="number">255</span>));</span><br><span class="line">        p = (<span class="keyword">char</span> *) &amp;iph-&gt;daddr;</span><br><span class="line">        <span class="built_in">sprintf</span>(dip, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, (p[<span class="number">0</span>] &amp; <span class="number">255</span>), (p[<span class="number">1</span>] &amp; <span class="number">255</span>), (p[<span class="number">2</span>] &amp; <span class="number">255</span>), (p[<span class="number">3</span>] &amp; <span class="number">255</span>));</span><br><span class="line">        pr_info(<span class="string">&quot;sip:%s -&gt; dip:%s\n&quot;</span>, sip, dip);</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;skb-&gt;dev-&gt;ifindex:%d tpi-&gt;flags%d tpi-&gt;key%d\n&quot;</span>, skb-&gt;dev-&gt;ifindex, tpi-&gt;flags, tpi-&gt;key);</span><br><span class="line">    tunnel = ip_tunnel_lookup(itn, skb-&gt;dev-&gt;ifindex, tpi-&gt;flags,</span><br><span class="line">            iph-&gt;saddr, iph-&gt;daddr, tpi-&gt;key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tunnel) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;ip_tunnel_lookup return not NULL\n&quot;</span>);</span><br><span class="line">        skb_pop_mac_header(skb);</span><br><span class="line">        <span class="keyword">if</span> (tunnel-&gt;collect_md) &#123;</span><br><span class="line">            __be16 flags;</span><br><span class="line">            __be64 tun_id;</span><br><span class="line"></span><br><span class="line">            pr_info(<span class="string">&quot;tunnel-&gt;collect_md != 0\n&quot;</span>);</span><br><span class="line">            flags = tpi-&gt;flags &amp; (TUNNEL_CSUM | TUNNEL_KEY);</span><br><span class="line">            tun_id = key_to_tunnel_id(tpi-&gt;key);</span><br><span class="line">            tun_dst = ip_tun_rx_dst(skb, flags, tun_id, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tun_dst)&#123;</span><br><span class="line">                pr_info(<span class="string">&quot;ip_tun_rx_dst return NULL\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> PACKET_REJECT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;ip_tunnel_rcv\n&quot;</span>);</span><br><span class="line">        ip_tunnel_rcv(tunnel, skb, tpi, tun_dst, log_ecn_error);</span><br><span class="line">        <span class="keyword">return</span> PACKET_RCVD;</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_lookup return NULL\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PACKET_REJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">gre_rcv</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tnl_ptk_info</span> <span class="title">tpi</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> csum_err = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> hdr_len;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;gre_rcv\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_IPGRE_BROADCAST</span></span><br><span class="line">    pr_info(<span class="string">&quot;gre_rcv is multicast?\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ipv4_is_multicast(ip_hdr(skb)-&gt;daddr)) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;gre_rcv is multicast yes\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* Looped back packet, drop it! */</span></span><br><span class="line">        <span class="keyword">if</span> (rt_is_output_route(skb_rtable(skb)))</span><br><span class="line">            <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    hdr_len = parse_gre_header(skb, &amp;tpi, &amp;csum_err);</span><br><span class="line">    pr_info(<span class="string">&quot;parse_gre_header\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hdr_len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;hdr_len &lt; 0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iptunnel_pull_header(skb, hdr_len, tpi.proto) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;iptunnel_pull_header &lt; 0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ipgre_rcv(skb, &amp;tpi) == PACKET_RCVD) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;ipgre_rcv == %d\n&quot;</span>, PACKET_RCVD);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, <span class="number">0</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;icmp_send\n&quot;</span>);</span><br><span class="line">drop:</span><br><span class="line">    pr_info(<span class="string">&quot;drop\n&quot;</span>);</span><br><span class="line">    kfree_skb(skb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>kernel/net/ipv4/ip_tunnel.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Fallback tunnel: no source, no destination, no key, no options</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Tunnel hash table:</span></span><br><span class="line"><span class="comment">   We require exact key match i.e. if a key is present in packet</span></span><br><span class="line"><span class="comment">   it will match only tunnel with the same key; if it is not present,</span></span><br><span class="line"><span class="comment">   it will match only keyless tunnel.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   All keysless packets, if not matched configured keyless tunnels</span></span><br><span class="line"><span class="comment">   will match fallback tunnel.</span></span><br><span class="line"><span class="comment">   Given src, dst and key, find appropriate for input tunnel.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">struct ip_tunnel *<span class="title">ip_tunnel_lookup</span><span class="params">(struct ip_tunnel_net *itn,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> link, __be16 flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        __be32 remote, __be32 local,</span></span></span><br><span class="line"><span class="function"><span class="params">        __be32 key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel</span> *<span class="title">t</span>, *<span class="title">cand</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_lookup\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    hash = ip_tunnel_hash(key, remote);</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_hash(%d, %d)-1&gt;hash:%d\n&quot;</span>, key, remote, hash);</span><br><span class="line"></span><br><span class="line">    head = &amp;itn-&gt;tunnels[hash];</span><br><span class="line">    pr_info(<span class="string">&quot;1head:%lu\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)head);</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;1local%d, saddr%d, remote%d, daddr%d, flags%x, IFF_UP%x\n&quot;</span>,</span><br><span class="line">                local, t-&gt;parms.iph.saddr, remote, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">        <span class="keyword">if</span> (local != t-&gt;parms.iph.saddr ||</span><br><span class="line">                remote != t-&gt;parms.iph.daddr ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;local%d != t-&gt;parms.iph.saddr%d || remote%d != t-&gt;parms.iph.daddr%d || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    local, t-&gt;parms.iph.saddr, remote, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;remote:%d, daddr:%d, saddr:%d, flags%x&amp;%x:%d\n&quot;</span>, remote, t-&gt;parms.iph.daddr, t-&gt;parms.iph.saddr, t-&gt;dev-&gt;flags, IFF_UP, (t-&gt;dev-&gt;flags &amp; IFF_UP));</span><br><span class="line">        <span class="keyword">if</span> (remote != t-&gt;parms.iph.daddr ||</span><br><span class="line">                t-&gt;parms.iph.saddr != <span class="number">0</span> ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;remote%d != t-&gt;parms.iph.daddr%d || t-&gt;parms.iph.saddr%d != 0 || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    remote, t-&gt;parms.iph.daddr, t-&gt;parms.iph.saddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash = ip_tunnel_hash(key, <span class="number">0</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_hash(%d, 0)-2&gt;hash:%d\n&quot;</span>, remote, hash);</span><br><span class="line">    head = &amp;itn-&gt;tunnels[hash];</span><br><span class="line">    pr_info(<span class="string">&quot;2head:%lu\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)head);</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;local:%d, saddr:%d, daddr:%d\n&quot;</span>, local, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr);</span><br><span class="line">        <span class="keyword">if</span> ((local != t-&gt;parms.iph.saddr || t-&gt;parms.iph.daddr != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">                (local != t-&gt;parms.iph.daddr || !ipv4_is_multicast(local)))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;(local%d != t-&gt;parms.iph.saddr%d || t-&gt;parms.iph.daddr%d != 0) &amp;&amp; (local%d != t-&gt;parms.iph.daddr%d || !ipv4_is_multicast(local)) continue\n&quot;</span>,</span><br><span class="line">                    local, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr, local, t-&gt;parms.iph.daddr);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; TUNNEL_NO_KEY)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;flags%x &amp; TUNNEL_NO_KEY%x goto skip_key_lookup\n&quot;</span>, flags, TUNNEL_NO_KEY);</span><br><span class="line">        <span class="keyword">goto</span> skip_key_lookup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.i_key != key ||</span><br><span class="line">                t-&gt;parms.iph.saddr != <span class="number">0</span> ||</span><br><span class="line">                t-&gt;parms.iph.daddr != <span class="number">0</span> ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.i_key%d != key%d || t-&gt;parms.iph.saddr%d != 0 || t-&gt;parms.iph.daddr%d != 0 || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    t-&gt;parms.i_key, key, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">skip_key_lookup:</span><br><span class="line">    <span class="keyword">if</span> (cand)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;cand not NULL return cand\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t = rcu_dereference(itn-&gt;collect_md_tun);</span><br><span class="line">    pr_info(<span class="string">&quot;t = rcu_dereference(itn-&gt;collect_md_tun)\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (t)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;t not NULL return t\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (itn-&gt;fb_tunnel_dev &amp;&amp; itn-&gt;fb_tunnel_dev-&gt;flags &amp; IFF_UP)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;itn-&gt;fb_tunnel_dev &amp;&amp; itn-&gt;fb_tunnel_dev-&gt;flags &amp; IFF_UP return netdev_priv(itn-&gt;fb_tunnel_dev);\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> netdev_priv(itn-&gt;fb_tunnel_dev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(ip_tunnel_lookup);</span><br></pre></td></tr></table></figure>
<h3 id="编译加载模块"><a href="#编译加载模块" class="headerlink" title="编译加载模块"></a>编译加载模块</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modinfo ip_gre</span><br><span class="line">modprobe gre</span><br><span class="line"><span class="comment">#make M=net/ipv4</span></span><br><span class="line">make modules SUBDIRS=net/ipv4;rmmod ip_gre;rmmod ip_tunnel;insmod net/ipv4/ip_tunnel.ko;insmod net/ipv4/ip_gre.ko</span><br></pre></td></tr></table></figure>
<h3 id="设备直连时"><a href="#设备直连时" class="headerlink" title="设备直连时"></a>设备直连时</h3><p>隧道是正常通信的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 2990.916244] output info dev:eth1 protocol:0x0800, 20.1.1.1-&gt;20.1.1.2 protocol:47 ip csum:578(1400) len:92</span><br><span class="line">[ 3056.971477] input info dev:eth1 protocol:0x0800, 20.1.1.2-&gt;20.1.1.1 protocol:47 ip csum:bacb(47819) len:92</span><br><span class="line">[ 3056.971494] ip_gre: gre_rcv</span><br><span class="line">[ 3056.971496] ip_gre: gre_rcv is multicast?</span><br><span class="line">[ 3056.971499] ip_gre: parse_gre_header</span><br><span class="line">[ 3056.971502] ip_gre: ipgre_rcv</span><br><span class="line">[ 3056.971504] ip_gre: tpi-&gt;proto !&#x3D; htons(ETH_P_TEB)</span><br><span class="line">[ 3056.971508] ip_gre: sip:20.1.1.2 -&gt; dip:20.1.1.1</span><br><span class="line">[ 3056.971511] ip_gre: skb-&gt;dev-&gt;ifindex:3 tpi-&gt;flags1024 tpi-&gt;key33554432</span><br><span class="line">[ 3056.971513] ip_tunnel: ip_tunnel_lookup</span><br><span class="line">[ 3056.971516] ip_tunnel: ip_tunnel_hash(33554432, 33620244)-1&gt;hash:73</span><br><span class="line">[ 3056.971519] ip_tunnel: 1head:3957364008</span><br><span class="line">[ 3056.971523] ip_tunnel: 1local16843028, saddr16843028, remote33620244, daddr33620244, flags91, IFF_UP1</span><br><span class="line">[ 3056.971525] ip_tunnel: t-&gt;parms.link3 &#x3D;&#x3D; link3 return t</span><br><span class="line">[ 3056.971527] ip_gre: ip_tunnel_lookup return not NULL</span><br><span class="line">[ 3056.971530] ip_gre: ip_tunnel_rcv</span><br><span class="line">[ 3056.971533] ip_gre: ipgre_rcv &#x3D;&#x3D; 0</span><br><span class="line">[ 3056.971561] input info dev:gre2 protocol:0x0800, 10.10.10.4-&gt;10.10.10.3 protocol:1 ip csum:8ca5(36005) len:64, type8</span><br><span class="line">[ 3056.971612] output info dev:gre2 protocol:0x0800, 10.10.10.3-&gt;10.10.10.4 protocol:1 ip csum:7f7a(32634) len:64, type0</span><br><span class="line">[ 3056.971632] output info dev:eth1 protocol:0x0800, 20.1.1.1-&gt;20.1.1.2 protocol:47 ip csum:f158(61784) len:92</span><br></pre></td></tr></table></figure>
<h3 id="测试跨网段时"><a href="#测试跨网段时" class="headerlink" title="测试跨网段时"></a>测试跨网段时</h3><p>隧道是不通的</p>
<p><img src="/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/gre%E9%94%99%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 3498.496802] input info dev:eth1 protocol:0x0800, 20.1.1.2-&gt;20.1.1.1 protocol:47 ip csum:709a(28826) len:92</span><br><span class="line">[ 3498.496810] ip_gre: gre_rcv</span><br><span class="line">[ 3498.496847] ip_gre: gre_rcv is multicast?</span><br><span class="line">[ 3498.497130] ip_gre: parse_gre_header</span><br><span class="line">[ 3498.497136] ip_gre: ipgre_rcv</span><br><span class="line">[ 3498.497141] ip_gre: tpi-&gt;proto !&#x3D; htons(ETH_P_TEB)</span><br><span class="line">[ 3498.497149] ip_gre: sip:20.1.1.2 -&gt; dip:20.1.1.1</span><br><span class="line">[ 3498.497155] ip_gre: skb-&gt;dev-&gt;ifindex:3 tpi-&gt;flags1024 tpi-&gt;key16777216</span><br><span class="line">[ 3498.497160] ip_tunnel: ip_tunnel_lookup</span><br><span class="line">[ 3498.497166] ip_tunnel: ip_tunnel_hash(16777216, 33620244)-1&gt;hash:75</span><br><span class="line">[ 3498.497171] ip_tunnel: 1head:3957811504</span><br><span class="line">[ 3498.497177] ip_tunnel: ip_tunnel_hash(33620244, 0)-2&gt;hash:0</span><br><span class="line">[ 3498.497183] ip_tunnel: 2head:3957811204</span><br><span class="line">[ 3498.497189] ip_tunnel: local:16843028, saddr:0, daddr:0</span><br><span class="line">[ 3498.497196] ip_tunnel: (local16843028 !&#x3D; t-&gt;parms.iph.saddr0 || t-&gt;parms.iph.daddr0 !&#x3D; 0) &amp;&amp; (local16843028 !&#x3D; t-&gt;parms.iph.daddr0 || !ipv4_is_multicast(local)) continue</span><br><span class="line">[ 3498.497204] ip_tunnel: t-&gt;parms.i_key0 !&#x3D; key16777216 || t-&gt;parms.iph.saddr0 !&#x3D; 0 || t-&gt;parms.iph.daddr0 !&#x3D; 0 || !(t-&gt;dev-&gt;flags80 &amp; IFF_UP1) continue</span><br><span class="line">[ 3498.497209] ip_tunnel: t &#x3D; rcu_dereference(itn-&gt;collect_md_tun)</span><br><span class="line">[ 3498.497214] ip_gre: ip_tunnel_lookup return NULL</span><br><span class="line">[ 3498.497219] ip_gre: icmp_send</span><br><span class="line">[ 3498.497223] ip_gre: drop</span><br></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>gre用于同网段的A类地址（即公网地址）的两个设备之间，跨网段是无法建立隧道的（除非关闭RouterB的NAT）。</p>

        
    </section>
</article>



<a id="pagenext" href="/2021/09/27/linux%E7%BD%91%E7%BB%9C2_%E7%BB%84%E6%92%AD/" class="article-next" title="linux网络2_组播"><i class="icon-arrow-right"></i></a>


<a id="pageprev" href="/2021/10/14/linux%E9%A9%B1%E5%8A%A8%E7%AC%94%E8%AE%B0/" class="article-prev" title="linux驱动笔记"><i class="icon-arrow-left"></i></a>




            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
