<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Zhihong&#39;s Blog</title>
    <meta name="author" content="Zhihong Li" />
    <meta name="keywords" content="zhbox" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Zhihong&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Zhihong&#39;s Blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/zhbox">
                <span class="nav-text">中盒</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://humble-zh.github.io"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/avatar.jpg" title="Zhihong Li">
                </a>
            </div>
            
            <div class="author-name">Zhihong Li</div>
            <div class="author-work">Program Monkey</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">GuangZhou, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/humble-zh/zhbox" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewBox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"></path>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/10/14/linux%E9%A9%B1%E5%8A%A8%E7%AC%94%E8%AE%B0/">linux驱动笔记</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-10-14T00:32:41.000Z" itemprop="datePublished">2021-10-14</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/driver/" rel="tag">driver</a>, <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="加载模块失败"><a href="#加载模块失败" class="headerlink" title="加载模块失败"></a>加载模块失败</h2><p><code>insmod xxx.ko</code>报错 <code>insmod: ERROR: could not insert module xxx.ko: Unknown symbol in module</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">modinfo xxx.ko | grep depends <span class="comment">#查看依赖的模块（lsmod 命令可以查看内核中已经的模块）</span></span><br><span class="line">modprobe &lt;缺少的依赖模块&gt;</span><br><span class="line">insmod xxx.ko</span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/">linux网络3_gre</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-10-12T01:32:41.000Z" itemprop="datePublished">2021-10-12</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/gre/" rel="tag">gre</a>, <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h2><p><img src="/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/gre%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<h2 id="配置gre"><a href="#配置gre" class="headerlink" title="配置gre"></a>配置gre</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerB</span></span><br><span class="line">remoteip=30.1.1.2</span><br><span class="line">localip=30.1.1.1</span><br><span class="line">greip=10.10.10.1</span><br><span class="line">grepeerip=10.10.10.2</span><br><span class="line">grename=gre1</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerA</span></span><br><span class="line">remoteip=30.1.1.1</span><br><span class="line">localip=30.1.1.2</span><br><span class="line">greip=10.10.10.2</span><br><span class="line">grepeerip=10.10.10.1</span><br><span class="line">grename=gre1</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#routerB and routerA</span></span><br><span class="line">lsmod|grep ip_gre || modprobe ip_gre</span><br><span class="line">ping -c1 <span class="variable">$&#123;remoteip&#125;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;make sure the network is ok plz&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">ip addr show <span class="variable">$&#123;grename&#125;</span> &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;grename&#125;</span> is already exist&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line">ip tunnel add <span class="variable">$&#123;grename&#125;</span> mode gre remote <span class="variable">$&#123;remoteip&#125;</span> <span class="built_in">local</span> <span class="variable">$&#123;localip&#125;</span> ikey 1 okey 1 ttl 255;</span><br><span class="line">ip addr add <span class="variable">$&#123;greip&#125;</span> dev <span class="variable">$&#123;grename&#125;</span> peer <span class="variable">$&#123;grepeerip&#125;</span>;</span><br><span class="line">ip link <span class="built_in">set</span> <span class="variable">$&#123;grename&#125;</span> up; <span class="comment">#mtu 1400</span></span><br><span class="line">ip addr show <span class="variable">$&#123;grename&#125;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="测试隧道连接"><a href="#测试隧道连接" class="headerlink" title="测试隧道连接"></a>测试隧道连接</h2><p>routerB <code>ping -I 10.10.10.1 10.10.10.2 -c2</code> 通路<br>routerA <code>ping -I 10.10.10.2 10.10.10.1 -c2</code> 通路</p>
<h2 id="配置路由表"><a href="#配置路由表" class="headerlink" title="配置路由表"></a>配置路由表</h2><p>routeB <code>ip route add 10.2.1.0/24 via 10.10.10.2</code><br>routeA <code>ip route add 10.1.1.0/24 via 10.10.10.1</code></p>
<h2 id="测试私网和隧道"><a href="#测试私网和隧道" class="headerlink" title="测试私网和隧道"></a>测试私网和隧道</h2><p>PC2 <code>ping 10.2.1.2</code> 通路<br>PC1 <code>ping 10.1.1.2</code> 通路</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [11:37:33]</span></span><br><span class="line">$ tcpdump -nvvvi gre1</span><br><span class="line">tcpdump: listening on gre1, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">12:31:30.309857 IP (tos 0x0, ttl 63, id 59102, offset 0, flags [DF], proto ICMP (1), length 84)</span><br><span class="line">    10.10.10.1 &gt; 10.2.1.2: ICMP <span class="built_in">echo</span> request, id 6, seq 1, length 64</span><br><span class="line">12:31:30.310258 IP (tos 0x0, ttl 63, id 17143, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.2.1.2 &gt; 10.10.10.1: ICMP <span class="built_in">echo</span> reply, id 6, seq 1, length 64</span><br></pre></td></tr></table></figure>
<h2 id="删除隧道"><a href="#删除隧道" class="headerlink" title="删除隧道"></a>删除隧道</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> gre1 down</span><br><span class="line">ip tunnel del gre1</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line"><span class="comment">## 卸载模块</span></span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line">rmmod ip_gre</span><br></pre></td></tr></table></figure>
<h2 id="TODO-创建多个隧道"><a href="#TODO-创建多个隧道" class="headerlink" title="TODO 创建多个隧道"></a>TODO 创建多个隧道</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhanzc1/article/details/80399337">两台设备之间建立多条gre通道</a></p>
<h2 id="额外问题"><a href="#额外问题" class="headerlink" title="额外问题"></a>额外问题</h2><ol>
<li><p>查看内核是否支持gre</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep GRE /boot/config-$(uname -r)</span><br><span class="line">sysctl net.netfilter.nf_conntrack_helper=1</span><br></pre></td></tr></table></figure></li>
<li><p><code>kernel: conntrack: generic helper won&#39;t handle protocol 47. Please consider loading the specific helper module.</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe nf_conntrack_proto_gre</span><br></pre></td></tr></table></figure></li>
<li><p>若需要<code>grep nf_nat_proto_gre || modprobe nf_nat_proto_gre</code></p>
</li>
<li><p>GRE是将一个数据包封装到另一个数据包中，因此你可能会遇到GRE的数据报大于网络接口所设定的数据包最大尺寸的情况。解决这种问题的方法是在隧道接口上配置ip tcp adjust-mss 1436。另外，虽然GRE并不支持加密，但是你可以通过tunnel key命令在隧道的两头各设置一个密钥。这个密钥其实就是一个明文的密码。或者使用gre over ipsec，那样就比较复杂了再另说。</p>
</li>
<li><p>GRE隧道没有状态控制，可能隧道的一端已经关闭，而另一端仍然开启。这一问题的解决方案就是在隧道两端开启keepalive数据包。它可以让隧道一端定时向另一端发送keepalive数据，确认端口保持开启状态。如果隧道的某一端没有按时收到keepalive数据，那么这一侧的隧道端口 也会关闭。</p>
</li>
</ol>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="代码打印"><a href="#代码打印" class="headerlink" title="代码打印"></a>代码打印</h3><p><code>kernel/net/ipv4/ip_gre.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ipgre_rcv</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct tnl_ptk_info *tpi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> dev_net(skb-&gt;dev);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">metadata_dst</span> *<span class="title">tun_dst</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel_net</span> *<span class="title">itn</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel</span> *<span class="title">tunnel</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> sip[<span class="number">18</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> dip[<span class="number">18</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;ipgre_rcv\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (tpi-&gt;proto == htons(ETH_P_TEB))&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;tpi-&gt;proto == htons(ETH_P_TEB)\n&quot;</span>);</span><br><span class="line">        itn = net_generic(net, gre_tap_net_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;tpi-&gt;proto != htons(ETH_P_TEB)\n&quot;</span>);</span><br><span class="line">        itn = net_generic(net, ipgre_net_id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iph = ip_hdr(skb);</span><br><span class="line">    <span class="keyword">if</span>(iph != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        p = (<span class="keyword">char</span> *) &amp;iph-&gt;saddr;</span><br><span class="line">        <span class="built_in">sprintf</span>(sip, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, (p[<span class="number">0</span>] &amp; <span class="number">255</span>), (p[<span class="number">1</span>] &amp; <span class="number">255</span>), (p[<span class="number">2</span>] &amp; <span class="number">255</span>), (p[<span class="number">3</span>] &amp; <span class="number">255</span>));</span><br><span class="line">        p = (<span class="keyword">char</span> *) &amp;iph-&gt;daddr;</span><br><span class="line">        <span class="built_in">sprintf</span>(dip, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, (p[<span class="number">0</span>] &amp; <span class="number">255</span>), (p[<span class="number">1</span>] &amp; <span class="number">255</span>), (p[<span class="number">2</span>] &amp; <span class="number">255</span>), (p[<span class="number">3</span>] &amp; <span class="number">255</span>));</span><br><span class="line">        pr_info(<span class="string">&quot;sip:%s -&gt; dip:%s\n&quot;</span>, sip, dip);</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;skb-&gt;dev-&gt;ifindex:%d tpi-&gt;flags%d tpi-&gt;key%d\n&quot;</span>, skb-&gt;dev-&gt;ifindex, tpi-&gt;flags, tpi-&gt;key);</span><br><span class="line">    tunnel = ip_tunnel_lookup(itn, skb-&gt;dev-&gt;ifindex, tpi-&gt;flags,</span><br><span class="line">            iph-&gt;saddr, iph-&gt;daddr, tpi-&gt;key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tunnel) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;ip_tunnel_lookup return not NULL\n&quot;</span>);</span><br><span class="line">        skb_pop_mac_header(skb);</span><br><span class="line">        <span class="keyword">if</span> (tunnel-&gt;collect_md) &#123;</span><br><span class="line">            __be16 flags;</span><br><span class="line">            __be64 tun_id;</span><br><span class="line"></span><br><span class="line">            pr_info(<span class="string">&quot;tunnel-&gt;collect_md != 0\n&quot;</span>);</span><br><span class="line">            flags = tpi-&gt;flags &amp; (TUNNEL_CSUM | TUNNEL_KEY);</span><br><span class="line">            tun_id = key_to_tunnel_id(tpi-&gt;key);</span><br><span class="line">            tun_dst = ip_tun_rx_dst(skb, flags, tun_id, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tun_dst)&#123;</span><br><span class="line">                pr_info(<span class="string">&quot;ip_tun_rx_dst return NULL\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> PACKET_REJECT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pr_info(<span class="string">&quot;ip_tunnel_rcv\n&quot;</span>);</span><br><span class="line">        ip_tunnel_rcv(tunnel, skb, tpi, tun_dst, log_ecn_error);</span><br><span class="line">        <span class="keyword">return</span> PACKET_RCVD;</span><br><span class="line">    &#125;</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_lookup return NULL\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> PACKET_REJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">gre_rcv</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tnl_ptk_info</span> <span class="title">tpi</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> csum_err = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> hdr_len;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;gre_rcv\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_IPGRE_BROADCAST</span></span><br><span class="line">    pr_info(<span class="string">&quot;gre_rcv is multicast?\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ipv4_is_multicast(ip_hdr(skb)-&gt;daddr)) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;gre_rcv is multicast yes\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* Looped back packet, drop it! */</span></span><br><span class="line">        <span class="keyword">if</span> (rt_is_output_route(skb_rtable(skb)))</span><br><span class="line">            <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    hdr_len = parse_gre_header(skb, &amp;tpi, &amp;csum_err);</span><br><span class="line">    pr_info(<span class="string">&quot;parse_gre_header\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hdr_len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;hdr_len &lt; 0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iptunnel_pull_header(skb, hdr_len, tpi.proto) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;iptunnel_pull_header &lt; 0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ipgre_rcv(skb, &amp;tpi) == PACKET_RCVD) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;ipgre_rcv == %d\n&quot;</span>, PACKET_RCVD);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    icmp_send(skb, ICMP_DEST_UNREACH, ICMP_PORT_UNREACH, <span class="number">0</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;icmp_send\n&quot;</span>);</span><br><span class="line">drop:</span><br><span class="line">    pr_info(<span class="string">&quot;drop\n&quot;</span>);</span><br><span class="line">    kfree_skb(skb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>kernel/net/ipv4/ip_tunnel.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Fallback tunnel: no source, no destination, no key, no options</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Tunnel hash table:</span></span><br><span class="line"><span class="comment">   We require exact key match i.e. if a key is present in packet</span></span><br><span class="line"><span class="comment">   it will match only tunnel with the same key; if it is not present,</span></span><br><span class="line"><span class="comment">   it will match only keyless tunnel.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   All keysless packets, if not matched configured keyless tunnels</span></span><br><span class="line"><span class="comment">   will match fallback tunnel.</span></span><br><span class="line"><span class="comment">   Given src, dst and key, find appropriate for input tunnel.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">struct ip_tunnel *<span class="title">ip_tunnel_lookup</span><span class="params">(struct ip_tunnel_net *itn,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> link, __be16 flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        __be32 remote, __be32 local,</span></span></span><br><span class="line"><span class="function"><span class="params">        __be32 key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_tunnel</span> *<span class="title">t</span>, *<span class="title">cand</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_lookup\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    hash = ip_tunnel_hash(key, remote);</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_hash(%d, %d)-1&gt;hash:%d\n&quot;</span>, key, remote, hash);</span><br><span class="line"></span><br><span class="line">    head = &amp;itn-&gt;tunnels[hash];</span><br><span class="line">    pr_info(<span class="string">&quot;1head:%lu\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)head);</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;1local%d, saddr%d, remote%d, daddr%d, flags%x, IFF_UP%x\n&quot;</span>,</span><br><span class="line">                local, t-&gt;parms.iph.saddr, remote, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">        <span class="keyword">if</span> (local != t-&gt;parms.iph.saddr ||</span><br><span class="line">                remote != t-&gt;parms.iph.daddr ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;local%d != t-&gt;parms.iph.saddr%d || remote%d != t-&gt;parms.iph.daddr%d || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    local, t-&gt;parms.iph.saddr, remote, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;remote:%d, daddr:%d, saddr:%d, flags%x&amp;%x:%d\n&quot;</span>, remote, t-&gt;parms.iph.daddr, t-&gt;parms.iph.saddr, t-&gt;dev-&gt;flags, IFF_UP, (t-&gt;dev-&gt;flags &amp; IFF_UP));</span><br><span class="line">        <span class="keyword">if</span> (remote != t-&gt;parms.iph.daddr ||</span><br><span class="line">                t-&gt;parms.iph.saddr != <span class="number">0</span> ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;remote%d != t-&gt;parms.iph.daddr%d || t-&gt;parms.iph.saddr%d != 0 || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    remote, t-&gt;parms.iph.daddr, t-&gt;parms.iph.saddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash = ip_tunnel_hash(key, <span class="number">0</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;ip_tunnel_hash(%d, 0)-2&gt;hash:%d\n&quot;</span>, remote, hash);</span><br><span class="line">    head = &amp;itn-&gt;tunnels[hash];</span><br><span class="line">    pr_info(<span class="string">&quot;2head:%lu\n&quot;</span>, (<span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)head);</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;local:%d, saddr:%d, daddr:%d\n&quot;</span>, local, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr);</span><br><span class="line">        <span class="keyword">if</span> ((local != t-&gt;parms.iph.saddr || t-&gt;parms.iph.daddr != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">                (local != t-&gt;parms.iph.daddr || !ipv4_is_multicast(local)))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;(local%d != t-&gt;parms.iph.saddr%d || t-&gt;parms.iph.daddr%d != 0) &amp;&amp; (local%d != t-&gt;parms.iph.daddr%d || !ipv4_is_multicast(local)) continue\n&quot;</span>,</span><br><span class="line">                    local, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr, local, t-&gt;parms.iph.daddr);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ip_tunnel_key_match(&amp;t-&gt;parms, flags, key))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;!ip_tunnel_key_match(&amp;t-&gt;parms, %x, %d) continue\n&quot;</span>, flags, key);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; TUNNEL_NO_KEY)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;flags%x &amp; TUNNEL_NO_KEY%x goto skip_key_lookup\n&quot;</span>, flags, TUNNEL_NO_KEY);</span><br><span class="line">        <span class="keyword">goto</span> skip_key_lookup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry_rcu(t, head, hash_node) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.i_key != key ||</span><br><span class="line">                t-&gt;parms.iph.saddr != <span class="number">0</span> ||</span><br><span class="line">                t-&gt;parms.iph.daddr != <span class="number">0</span> ||</span><br><span class="line">                !(t-&gt;dev-&gt;flags &amp; IFF_UP))&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.i_key%d != key%d || t-&gt;parms.iph.saddr%d != 0 || t-&gt;parms.iph.daddr%d != 0 || !(t-&gt;dev-&gt;flags%x &amp; IFF_UP%x) continue\n&quot;</span>,</span><br><span class="line">                    t-&gt;parms.i_key, key, t-&gt;parms.iph.saddr, t-&gt;parms.iph.daddr, t-&gt;dev-&gt;flags, IFF_UP);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t-&gt;parms.link == link)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d == link%d return t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!cand)&#123;</span><br><span class="line">            pr_info(<span class="string">&quot;t-&gt;parms.link%d != link%d cand=t\n&quot;</span>, t-&gt;parms.link, link);</span><br><span class="line">            cand = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">skip_key_lookup:</span><br><span class="line">    <span class="keyword">if</span> (cand)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;cand not NULL return cand\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t = rcu_dereference(itn-&gt;collect_md_tun);</span><br><span class="line">    pr_info(<span class="string">&quot;t = rcu_dereference(itn-&gt;collect_md_tun)\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (t)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;t not NULL return t\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (itn-&gt;fb_tunnel_dev &amp;&amp; itn-&gt;fb_tunnel_dev-&gt;flags &amp; IFF_UP)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;itn-&gt;fb_tunnel_dev &amp;&amp; itn-&gt;fb_tunnel_dev-&gt;flags &amp; IFF_UP return netdev_priv(itn-&gt;fb_tunnel_dev);\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> netdev_priv(itn-&gt;fb_tunnel_dev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(ip_tunnel_lookup);</span><br></pre></td></tr></table></figure>
<h3 id="编译加载模块"><a href="#编译加载模块" class="headerlink" title="编译加载模块"></a>编译加载模块</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modinfo ip_gre</span><br><span class="line">modprobe gre</span><br><span class="line"><span class="comment">#make M=net/ipv4</span></span><br><span class="line">make modules SUBDIRS=net/ipv4;rmmod ip_gre;rmmod ip_tunnel;insmod net/ipv4/ip_tunnel.ko;insmod net/ipv4/ip_gre.ko</span><br></pre></td></tr></table></figure>
<h3 id="设备直连时"><a href="#设备直连时" class="headerlink" title="设备直连时"></a>设备直连时</h3><p>隧道是正常通信的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 2990.916244] output info dev:eth1 protocol:0x0800, 20.1.1.1-&gt;20.1.1.2 protocol:47 ip csum:578(1400) len:92</span><br><span class="line">[ 3056.971477] input info dev:eth1 protocol:0x0800, 20.1.1.2-&gt;20.1.1.1 protocol:47 ip csum:bacb(47819) len:92</span><br><span class="line">[ 3056.971494] ip_gre: gre_rcv</span><br><span class="line">[ 3056.971496] ip_gre: gre_rcv is multicast?</span><br><span class="line">[ 3056.971499] ip_gre: parse_gre_header</span><br><span class="line">[ 3056.971502] ip_gre: ipgre_rcv</span><br><span class="line">[ 3056.971504] ip_gre: tpi-&gt;proto !&#x3D; htons(ETH_P_TEB)</span><br><span class="line">[ 3056.971508] ip_gre: sip:20.1.1.2 -&gt; dip:20.1.1.1</span><br><span class="line">[ 3056.971511] ip_gre: skb-&gt;dev-&gt;ifindex:3 tpi-&gt;flags1024 tpi-&gt;key33554432</span><br><span class="line">[ 3056.971513] ip_tunnel: ip_tunnel_lookup</span><br><span class="line">[ 3056.971516] ip_tunnel: ip_tunnel_hash(33554432, 33620244)-1&gt;hash:73</span><br><span class="line">[ 3056.971519] ip_tunnel: 1head:3957364008</span><br><span class="line">[ 3056.971523] ip_tunnel: 1local16843028, saddr16843028, remote33620244, daddr33620244, flags91, IFF_UP1</span><br><span class="line">[ 3056.971525] ip_tunnel: t-&gt;parms.link3 &#x3D;&#x3D; link3 return t</span><br><span class="line">[ 3056.971527] ip_gre: ip_tunnel_lookup return not NULL</span><br><span class="line">[ 3056.971530] ip_gre: ip_tunnel_rcv</span><br><span class="line">[ 3056.971533] ip_gre: ipgre_rcv &#x3D;&#x3D; 0</span><br><span class="line">[ 3056.971561] input info dev:gre2 protocol:0x0800, 10.10.10.4-&gt;10.10.10.3 protocol:1 ip csum:8ca5(36005) len:64, type8</span><br><span class="line">[ 3056.971612] output info dev:gre2 protocol:0x0800, 10.10.10.3-&gt;10.10.10.4 protocol:1 ip csum:7f7a(32634) len:64, type0</span><br><span class="line">[ 3056.971632] output info dev:eth1 protocol:0x0800, 20.1.1.1-&gt;20.1.1.2 protocol:47 ip csum:f158(61784) len:92</span><br></pre></td></tr></table></figure>
<h3 id="测试跨网段时"><a href="#测试跨网段时" class="headerlink" title="测试跨网段时"></a>测试跨网段时</h3><p>隧道是不通的</p>
<p><img src="/2021/10/12/linux%E7%BD%91%E7%BB%9C3_gre/gre%E9%94%99%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[ 3498.496802] input info dev:eth1 protocol:0x0800, 20.1.1.2-&gt;20.1.1.1 protocol:47 ip csum:709a(28826) len:92</span><br><span class="line">[ 3498.496810] ip_gre: gre_rcv</span><br><span class="line">[ 3498.496847] ip_gre: gre_rcv is multicast?</span><br><span class="line">[ 3498.497130] ip_gre: parse_gre_header</span><br><span class="line">[ 3498.497136] ip_gre: ipgre_rcv</span><br><span class="line">[ 3498.497141] ip_gre: tpi-&gt;proto !&#x3D; htons(ETH_P_TEB)</span><br><span class="line">[ 3498.497149] ip_gre: sip:20.1.1.2 -&gt; dip:20.1.1.1</span><br><span class="line">[ 3498.497155] ip_gre: skb-&gt;dev-&gt;ifindex:3 tpi-&gt;flags1024 tpi-&gt;key16777216</span><br><span class="line">[ 3498.497160] ip_tunnel: ip_tunnel_lookup</span><br><span class="line">[ 3498.497166] ip_tunnel: ip_tunnel_hash(16777216, 33620244)-1&gt;hash:75</span><br><span class="line">[ 3498.497171] ip_tunnel: 1head:3957811504</span><br><span class="line">[ 3498.497177] ip_tunnel: ip_tunnel_hash(33620244, 0)-2&gt;hash:0</span><br><span class="line">[ 3498.497183] ip_tunnel: 2head:3957811204</span><br><span class="line">[ 3498.497189] ip_tunnel: local:16843028, saddr:0, daddr:0</span><br><span class="line">[ 3498.497196] ip_tunnel: (local16843028 !&#x3D; t-&gt;parms.iph.saddr0 || t-&gt;parms.iph.daddr0 !&#x3D; 0) &amp;&amp; (local16843028 !&#x3D; t-&gt;parms.iph.daddr0 || !ipv4_is_multicast(local)) continue</span><br><span class="line">[ 3498.497204] ip_tunnel: t-&gt;parms.i_key0 !&#x3D; key16777216 || t-&gt;parms.iph.saddr0 !&#x3D; 0 || t-&gt;parms.iph.daddr0 !&#x3D; 0 || !(t-&gt;dev-&gt;flags80 &amp; IFF_UP1) continue</span><br><span class="line">[ 3498.497209] ip_tunnel: t &#x3D; rcu_dereference(itn-&gt;collect_md_tun)</span><br><span class="line">[ 3498.497214] ip_gre: ip_tunnel_lookup return NULL</span><br><span class="line">[ 3498.497219] ip_gre: icmp_send</span><br><span class="line">[ 3498.497223] ip_gre: drop</span><br></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>gre用于同网段的A类地址（即公网地址）的两个设备之间，跨网段是无法建立隧道的（除非关闭RouterB的NAT）。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/27/linux%E7%BD%91%E7%BB%9C2_%E7%BB%84%E6%92%AD/">linux网络2_组播</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-09-27T08:32:41.000Z" itemprop="datePublished">2021-09-27</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/igmp/" rel="tag">igmp</a>, <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>, <a class="article-tag-link" href="/tags/multicast/" rel="tag">multicast</a>, <a class="article-tag-link" href="/tags/pim/" rel="tag">pim</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="安装pimd"><a href="#安装pimd" class="headerlink" title="安装pimd"></a>安装pimd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install pimd</span><br></pre></td></tr></table></figure>
<h2 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h2><p><img src="/2021/09/27/linux%E7%BD%91%E7%BB%9C2_%E7%BB%84%E6%92%AD/multicast%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<h2 id="配置ospf"><a href="#配置ospf" class="headerlink" title="配置ospf"></a>配置ospf</h2><p>参考《linux网络1_ospf》分别对routeA和routeB进行ospf功能配置，或者设置默认路由，使得组播源、接收端1、接收端2这三者之间能两两相互ping通</p>
<h2 id="搭建组播源与接收端"><a href="#搭建组播源与接收端" class="headerlink" title="搭建组播源与接收端"></a>搭建组播源与接收端</h2><p>参考《vlc组播测试Server及Client使用》</p>
<h2 id="配置RouterA"><a href="#配置RouterA" class="headerlink" title="配置RouterA"></a>配置RouterA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [14:27:40]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/pimd.conf</span><br><span class="line">phyint eth2 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">phyint eth3 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">phyint eth4 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">bsr-candidate priority 5</span><br><span class="line">rp-candidate time 30 priority 20 <span class="comment">#动态选举汇聚点RP路由器(也可设置为静态RP,但所有路由必须设置同一个)</span></span><br><span class="line">spt-threshold packets 0 interval 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [14:27:47]</span></span><br><span class="line">$ systemctl restart pimd.service</span><br></pre></td></tr></table></figure>
<h2 id="配置RouterB"><a href="#配置RouterB" class="headerlink" title="配置RouterB"></a>配置RouterB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerB in / [14:33:40]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/pimd.conf</span><br><span class="line">phyint eth2 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">phyint eth3 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">phyint eth4 <span class="built_in">disable</span> <span class="comment">#重要：关掉不参与组播功能的端口，免得影响组播</span></span><br><span class="line">bsr-candidate priority 5</span><br><span class="line">rp-candidate time 30 priority 20 <span class="comment">#动态选举汇聚点RP路由器(也可设置为静态RP,但所有路由必须设置同一个)</span></span><br><span class="line">spt-threshold packets 0 interval 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [14:33:47]</span></span><br><span class="line">$ systemctl restart pimd.service</span><br></pre></td></tr></table></figure>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -u pimd.service</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [15:04:54]</span></span><br><span class="line">$ ip mroute show to 239.255.255.249</span><br><span class="line">(10.2.1.2, 239.255.255.249)      Iif: eth0       Oifs: eth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [15:05:01]</span></span><br><span class="line">$ pimd --show-routes</span><br><span class="line">Virtual Interface Table ======================================================</span><br><span class="line">Vif  Local Address    Subnet              Thresh  Flags      Neighbors</span><br><span class="line">---  ---------------  ------------------  ------  ---------  -----------------</span><br><span class="line">  0  10.2.1.1         10.2.1/24                1  DR NO-NBR</span><br><span class="line">  1  30.1.1.2         30.1.1/24                1  DR PIM     30.1.1.1</span><br><span class="line">  2  192.168.255.1    192.168.255              1  DISABLED</span><br><span class="line">  3  10.2.1.1         register_vif0            1</span><br><span class="line"></span><br><span class="line"> Vif  SSM Group        Sources</span><br><span class="line"></span><br><span class="line">Multicast Routing Table ======================================================</span><br><span class="line">----------------------------------- (*,G) ------------------------------------</span><br><span class="line">Source           Group            RP Address       Flags</span><br><span class="line">---------------  ---------------  ---------------  ---------------------------</span><br><span class="line">INADDR_ANY       239.255.255.249  30.1.1.2         WC RP</span><br><span class="line">Joined   oifs: ....</span><br><span class="line">Pruned   oifs: ....</span><br><span class="line">Leaves   oifs: .l..</span><br><span class="line">Asserted oifs: ....</span><br><span class="line">Outgoing oifs: .o..</span><br><span class="line">Incoming     : ...I</span><br><span class="line"></span><br><span class="line">TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3</span><br><span class="line">             0    45     0       0        0  0  0  0</span><br><span class="line">----------------------------------- (S,G) ------------------------------------</span><br><span class="line">Source           Group            RP Address       Flags</span><br><span class="line">---------------  ---------------  ---------------  ---------------------------</span><br><span class="line">10.2.1.2         239.255.255.249  30.1.1.2         SPT CACHE SG</span><br><span class="line">Joined   oifs: ....</span><br><span class="line">Pruned   oifs: ....</span><br><span class="line">Leaves   oifs: .l..</span><br><span class="line">Asserted oifs: ....</span><br><span class="line">Outgoing oifs: .o..</span><br><span class="line">Incoming     : I...</span><br><span class="line"></span><br><span class="line">TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3</span><br><span class="line">           175    30     0       0        0  0  0  0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>routerA的组播路由表出现了 <code>(10.2.1.2, 239.255.255.249)      Iif: eth0       Oifs: eth1</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerB in / [15:08:16]</span></span><br><span class="line">$ ip mroute show to 239.255.255.249</span><br><span class="line">(30.1.1.2, 239.255.255.249)      Iif: eth1       Oifs: eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [15:10:21]</span></span><br><span class="line">$ pimd --show-routes</span><br><span class="line">Virtual Interface Table ======================================================</span><br><span class="line">Vif  Local Address    Subnet              Thresh  Flags      Neighbors</span><br><span class="line">---  ---------------  ------------------  ------  ---------  -----------------</span><br><span class="line">  0  10.1.1.1         10.1.1/24                1  DR NO-NBR</span><br><span class="line">  1  30.1.1.1         30.1.1/24                1  PIM        30.1.1.2</span><br><span class="line">  2  192.168.20.1     192.168.20               1  DISABLED</span><br><span class="line">  3  192.168.30.1     192.168.30               1  DISABLED</span><br><span class="line">  4  10.1.1.1         register_vif0            1</span><br><span class="line"></span><br><span class="line"> Vif  SSM Group        Sources</span><br><span class="line"></span><br><span class="line">Multicast Routing Table ======================================================</span><br><span class="line">----------------------------------- (*,G) ------------------------------------</span><br><span class="line">Source           Group            RP Address       Flags</span><br><span class="line">---------------  ---------------  ---------------  ---------------------------</span><br><span class="line">INADDR_ANY       239.255.255.249  30.1.1.2         WC RP</span><br><span class="line">Joined   oifs: .....</span><br><span class="line">Pruned   oifs: .....</span><br><span class="line">Leaves   oifs: l....</span><br><span class="line">Asserted oifs: .....</span><br><span class="line">Outgoing oifs: o....</span><br><span class="line">Incoming     : .I...</span><br><span class="line"></span><br><span class="line">TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4</span><br><span class="line">             0    40     0       0        0  0  0  0  0</span><br><span class="line">----------------------------------- (S,G) ------------------------------------</span><br><span class="line">Source           Group            RP Address       Flags</span><br><span class="line">---------------  ---------------  ---------------  ---------------------------</span><br><span class="line">30.1.1.2         239.255.255.249  30.1.1.2         SPT CACHE SG</span><br><span class="line">Joined   oifs: .....</span><br><span class="line">Pruned   oifs: .....</span><br><span class="line">Leaves   oifs: l....</span><br><span class="line">Asserted oifs: .....</span><br><span class="line">Outgoing oifs: o....</span><br><span class="line">Incoming     : .I...</span><br><span class="line"></span><br><span class="line">TIMERS:  Entry    JP    RS  Assert VIFS:  0  1  2  3  4</span><br><span class="line">           190    45     0       0        0  0  0  0  0</span><br></pre></td></tr></table></figure>
<p>routerB的组播路由表出现了 <code>(30.1.1.2, 239.255.255.249)      Iif: eth1       Oifs: eth0</code></p>
<p>备注：可以看到routerA和routerB的汇聚点选举结果为 RP Address:30.1.1.2</p>
<h2 id="测试组播通路"><a href="#测试组播通路" class="headerlink" title="测试组播通路"></a>测试组播通路</h2><p>接收端1和接收端2上面的vlc都能播放<code>udp://@239.255.255.249:1249</code>的视频。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/27/linux%E7%BD%91%E7%BB%9C1_ospf/">linux网络1_ospf</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-09-27T07:32:41.000Z" itemprop="datePublished">2021-09-27</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>, <a class="article-tag-link" href="/tags/ospf/" rel="tag">ospf</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="安装quagga"><a href="#安装quagga" class="headerlink" title="安装quagga"></a>安装quagga</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install quagga</span><br></pre></td></tr></table></figure>
<h2 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h2><p><img src="/2021/09/27/linux%E7%BD%91%E7%BB%9C1_ospf/ospf%E6%8B%93%E6%89%91.jpg" alt="TOPO"></p>
<h2 id="配置RouterA"><a href="#配置RouterA" class="headerlink" title="配置RouterA"></a>配置RouterA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [11:37:11]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/debian.conf</span><br><span class="line">vtysh_enable=yes</span><br><span class="line">zebra_options=<span class="string">&quot;  --daemon -A 127.0.0.1&quot;</span></span><br><span class="line">ospfd_options=<span class="string">&quot;  --daemon -A 127.0.0.1&quot;</span></span><br><span class="line">watchquagga_enable=yes</span><br><span class="line">watchquagga_options=(--daemon)</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [11:37:21]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/zebra.conf</span><br><span class="line">hostname Router_A <span class="comment">#各路由不一样</span></span><br><span class="line">password testpassword</span><br><span class="line"><span class="built_in">enable</span> password testpassword</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [11:37:26]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/ospfd.conf</span><br><span class="line">hostname Router_A <span class="comment">#跟zebra.conf一样</span></span><br><span class="line">password testpassword</span><br><span class="line"><span class="built_in">enable</span> password testpassword</span><br><span class="line">router ospf</span><br><span class="line">    ospf router-id 30.1.1.2 <span class="comment">#自身的ip，连接邻居路由</span></span><br><span class="line">    network 10.2.1.0/24 area 1</span><br><span class="line">    network 30.1.1.0/24 area 0 <span class="comment">#邻居相同网段 area也需要是0</span></span><br><span class="line">debug ospf event</span><br><span class="line"><span class="built_in">log</span> file /usr/<span class="built_in">local</span>/etc/ospfd.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [11:37:32]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/daemons</span><br><span class="line">zebra=yes</span><br><span class="line">ospfd=yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [11:37:39]</span></span><br><span class="line">$ systemctl restart quagga.service</span><br></pre></td></tr></table></figure>

<h2 id="配置RouterB"><a href="#配置RouterB" class="headerlink" title="配置RouterB"></a>配置RouterB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerB in / [11:39:11]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/debian.conf</span><br><span class="line">vtysh_enable=yes</span><br><span class="line">zebra_options=<span class="string">&quot;  --daemon -A 127.0.0.1&quot;</span></span><br><span class="line">ospfd_options=<span class="string">&quot;  --daemon -A 127.0.0.1&quot;</span></span><br><span class="line">watchquagga_enable=yes</span><br><span class="line">watchquagga_options=(--daemon)</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [11:39:18]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/zebra.conf</span><br><span class="line">hostname Router_B <span class="comment">#各路由不一样</span></span><br><span class="line">password testpassword</span><br><span class="line"><span class="built_in">enable</span> password testpassword</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [11:39:24]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/ospfd.conf</span><br><span class="line">hostname Router_B <span class="comment">#跟zebra.conf一样</span></span><br><span class="line">password testpassword</span><br><span class="line"><span class="built_in">enable</span> password testpassword</span><br><span class="line">router ospf</span><br><span class="line">    ospf router-id 30.1.1.1 <span class="comment">#自身的ip，连接邻居路由</span></span><br><span class="line">    network 10.1.1.0/24 area 1</span><br><span class="line">    network 30.1.1.0/24 area 0 <span class="comment">#邻居相同网段 area也需要是0</span></span><br><span class="line">debug ospf event</span><br><span class="line"><span class="built_in">log</span> file /usr/<span class="built_in">local</span>/etc/ospfd.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [11:39:31]</span></span><br><span class="line">$ grep -v <span class="string">&quot;^#&quot;</span> /etc/quagga/daemons</span><br><span class="line">zebra=yes</span><br><span class="line">ospfd=yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerB in / [11:39:37]</span></span><br><span class="line">$ systemctl restart quagga.service</span><br></pre></td></tr></table></figure>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -u quagga.service</span><br><span class="line">...</span><br><span class="line">Sep 27 11:25:29 ubuntu watchquagga[12328]: ospfd state -&gt; up : connect succeeded</span><br><span class="line">Sep 27 11:25:29 ubuntu watchquagga[12328]: zebra state -&gt; up : connect succeeded</span><br></pre></td></tr></table></figure>
<h2 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [11:41:51]</span></span><br><span class="line">$ ip route</span><br><span class="line">10.1.1.0/24 via 30.1.1.1 dev eth1  proto zebra  metric 20</span><br><span class="line">10.2.1.0/24 dev eth0  proto kernel  scope link  src 10.2.1.1</span><br><span class="line">30.1.1.0/24 dev eth1  proto kernel  scope link  src 30.1.1.2</span><br><span class="line">192.168.255.0/24 dev eth3  proto kernel  scope link  src 192.168.255.1</span><br></pre></td></tr></table></figure>
<p>routerA的路由表出现了 <code>10.1.1.0/24 via 30.1.1.1 dev eth1  proto zebra  metric 20</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerB in / [11:39:49]</span></span><br><span class="line">$ ip route</span><br><span class="line">10.1.1.0/24 dev eth0  proto kernel  scope link  src 10.1.1.1 linkdown</span><br><span class="line">10.2.1.0/24 via 30.1.1.2 dev eth1  proto zebra  metric 20</span><br><span class="line">30.1.1.0/24 dev eth1  proto kernel  scope link  src 30.1.1.1</span><br><span class="line">192.168.20.0/24 dev eth2  proto kernel  scope link  src 192.168.20.1 linkdown</span><br><span class="line">192.168.30.0/24 dev eth3  proto kernel  scope link  src 192.168.30.1 linkdown</span><br></pre></td></tr></table></figure>
<p>routerB的路由表出现了 <code>10.2.1.0/24 via 30.1.1.2 dev eth1  proto zebra  metric 20</code></p>
<h2 id="测试网络通路"><a href="#测试网络通路" class="headerlink" title="测试网络通路"></a>测试网络通路</h2><p>PC1 ping PC2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zh @ li in ~ [11:44:36]</span></span><br><span class="line">$ ping 10.1.1.2</span><br><span class="line">PING 10.1.1.2 (10.1.1.2) 56(84) 字节的数据。</span><br><span class="line">64 字节，来自 10.1.1.1: icmp_seq=1 ttl=64 时间=0.607 毫秒</span><br><span class="line">64 字节，来自 10.1.1.1: icmp_seq=2 ttl=64 时间=0.564 毫秒</span><br><span class="line">64 字节，来自 10.1.1.1: icmp_seq=3 ttl=64 时间=0.602 毫秒</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>PC2 ping PC1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zh @ li in ~ [11:44:36]</span></span><br><span class="line">$ ping 10.2.1.2</span><br><span class="line">PING 10.2.1.2 (10.2.1.2) 56(84) 字节的数据。</span><br><span class="line">64 字节，来自 10.2.1.1: icmp_seq=1 ttl=64 时间=0.647 毫秒</span><br><span class="line">64 字节，来自 10.2.1.1: icmp_seq=2 ttl=64 时间=0.534 毫秒</span><br><span class="line">64 字节，来自 10.2.1.1: icmp_seq=3 ttl=64 时间=0.402 毫秒</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<h2 id="打开命令行配置"><a href="#打开命令行配置" class="headerlink" title="打开命令行配置"></a>打开命令行配置</h2><p><code>telnet localhost 2601</code> 密码在/etc/quagga/zebra.conf<br><code>telnet localhost 2604</code> 密码在/etc/quagga/ospfd.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ routerA in / [13:53:38] C:1</span></span><br><span class="line">$ telnet localhost 2601</span><br><span class="line">Trying ::1...</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to localhost.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Hello, this is Quagga (version 0.99.24.1).</span><br><span class="line">Copyright 1996-2005 Kunihiro Ishiguro, et al.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User Access Verification</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Router_A&gt; show ip ospf neighbor</span><br><span class="line">...</span><br><span class="line">Router_A&gt; <span class="built_in">exit</span></span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [13:54:03] C:1</span></span><br><span class="line">$ telnet localhost 2604</span><br><span class="line">Trying ::1...</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to localhost.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Hello, this is Quagga (version 0.99.24.1).</span><br><span class="line">Copyright 1996-2005 Kunihiro Ishiguro, et al.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">User Access Verification</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Router_A&gt;</span><br><span class="line">Router_A&gt; <span class="built_in">exit</span></span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line"><span class="comment"># root @ routerA in / [13:54:19] C:1</span></span><br><span class="line">$</span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/23/igmp%E5%92%8Cpim%E7%AC%94%E8%AE%B0/">igmp和pim笔记</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-09-23T07:32:41.000Z" itemprop="datePublished">2021-09-23</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/igmp/" rel="tag">igmp</a>, <a class="article-tag-link" href="/tags/pim/" rel="tag">pim</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>igmp和pim介绍</p>
        
        <p class="article-more-link">
            <a href="/2021/09/23/igmp%E5%92%8Cpim%E7%AC%94%E8%AE%B0/#more">
                <span class="vm">阅读更多</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/09/22/vlc%E7%BB%84%E6%92%AD%E6%B5%8B%E8%AF%95Server%E5%8F%8AClient%E4%BD%BF%E7%94%A8/">VLC组播测试Server及Client使用</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-09-22T07:32:41.000Z" itemprop="datePublished">2021-09-22</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/multicast/" rel="tag">multicast</a>, <a class="article-tag-link" href="/tags/vlc/" rel="tag">vlc</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="VLC组播测试Server及Client使用"><a href="#VLC组播测试Server及Client使用" class="headerlink" title="VLC组播测试Server及Client使用"></a>VLC组播测试Server及Client使用</h2><blockquote>
<p>VLC是一种开源的媒体播放器，但同时又可以用于组播测试。可以用VLC搭建组播Server，也可以用VLC作客户端接受组播流。</p>
</blockquote>
<h3 id="一-使用VLC搭建组播Server"><a href="#一-使用VLC搭建组播Server" class="headerlink" title="一. 使用VLC搭建组播Server"></a>一. 使用VLC搭建组播Server</h3><h4 id="1-修改TTL"><a href="#1-修改TTL" class="headerlink" title="1. 修改TTL"></a>1. 修改TTL</h4><p><strong>注意：默认VLC图形方式下打出的组播流其IP报头中的<code>TTL=1</code>。</strong></p>
<ol>
<li>菜单 工具 偏好设置</li>
<li>简明偏好设置 显示设置:全部(左下角)</li>
<li>高级偏好设置 串流输出 访问输出 跳数限制(TTL):64 多播输出接口(若无法指定，请在win10网络管理内禁用其他的接口)</li>
</ol>
<h4 id="2-设置组播server"><a href="#2-设置组播server" class="headerlink" title="2. 设置组播server"></a>2. 设置组播server</h4><ol>
<li>菜单 媒体 流</li>
<li>网络 删除URL</li>
<li>文件 添加 选择文件 打开/加载/确定 串流 下一步</li>
<li>勾选在本地显示 新目标:UDP(legacy) 添加</li>
<li>地址(239.10.1.1) 端口(1234) 下一步</li>
<li>勾选激活转码 配置文件(Video - H.264 + MP3(MP4))</li>
<li>取消串流所有基本流，生成的串流输出字符串(默认) 流</li>
</ol>
<p><code>注意：默认UDP的组播流输出接口是根据系统本地的路由表来选择的。</code>比如：</p>
<p><img src="/2021/09/22/vlc%E7%BB%84%E6%92%AD%E6%B5%8B%E8%AF%95Server%E5%8F%8AClient%E4%BD%BF%E7%94%A8/%E8%B7%AF%E7%94%B1%E8%A1%A8.png"></p>
<p><strong>如果输出组播的IP地址为239.10.1.1，那么根据上述路由表组播流将发往192.168.56.1那个接口。因为该接口的路由metric相对较小<code>（276）</code>。</strong></p>
<h3 id="二-VLC客户端接受组播流。"><a href="#二-VLC客户端接受组播流。" class="headerlink" title="二. VLC客户端接受组播流。"></a>二. VLC客户端接受组播流。</h3><ol>
<li>菜单 媒体 打开网络串流</li>
<li>网络 URL(udp://@239.10.1.1:1234) 播放</li>
</ol>
<h3 id="三-命令行操作方式（windows操作系统）——UDP（legacy）实现方式。"><a href="#三-命令行操作方式（windows操作系统）——UDP（legacy）实现方式。" class="headerlink" title="三. 命令行操作方式（windows操作系统）——UDP（legacy）实现方式。"></a>三. 命令行操作方式（windows操作系统）——UDP（legacy）实现方式。</h3><h3 id="1-Server侧打流。"><a href="#1-Server侧打流。" class="headerlink" title="1. Server侧打流。"></a>1. Server侧打流。</h3><ul>
<li>先通过添加组播路由条目的方式指定组播流的输出接口<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add 239.0.0.0 mask 255.0.0.0 192.168.1.100</span><br></pre></td></tr></table></figure></li>
<li>使用VLC打组播流<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc -vvv D:\bak\others\组播测试片源\hello.mp4 --sout udp:239.10.1.1:1234 --ttl 10</span><br></pre></td></tr></table></figure>
<h3 id="2-Client侧接受流。"><a href="#2-Client侧接受流。" class="headerlink" title="2. Client侧接受流。"></a>2. Client侧接受流。</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc udp://@239.10.1.1:1234</span><br></pre></td></tr></table></figure>
<h3 id="四-命令行操作方式（windows操作系统）——RTP实现方式。"><a href="#四-命令行操作方式（windows操作系统）——RTP实现方式。" class="headerlink" title="四. 命令行操作方式（windows操作系统）——RTP实现方式。"></a>四. 命令行操作方式（windows操作系统）——RTP实现方式。</h3></li>
</ul>
<h3 id="1-Server侧打流"><a href="#1-Server侧打流" class="headerlink" title="1. Server侧打流"></a>1. Server侧打流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc -vvv hello.mp4 --sout <span class="string">&quot;#transcode&#123;vcodec=h264,vb=0,scale=0,acodec=mpga,ab=128,channels=2,samplerate=44100&#125;:rtp&#123;dst=239.10.1.1,port=4321,mux=ts,ttl=20&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Client侧接受流"><a href="#2-Client侧接受流" class="headerlink" title="2. Client侧接受流"></a>2. Client侧接受流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc rtp://@239.10.1.1:4321</span><br></pre></td></tr></table></figure>
<h3 id="五-命令行操作方式（windows操作系统）——RTSP实现方式。"><a href="#五-命令行操作方式（windows操作系统）——RTSP实现方式。" class="headerlink" title="五. 命令行操作方式（windows操作系统）——RTSP实现方式。"></a>五. 命令行操作方式（windows操作系统）——RTSP实现方式。</h3><h3 id="1-Server侧打流-1"><a href="#1-Server侧打流-1" class="headerlink" title="1. Server侧打流"></a>1. Server侧打流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc -vvv sample1.avi --sout <span class="string">&quot;#transcode&#123;vcodec=h264,vb=0,scale=0,acodec=mpga,ab=128,channels=2,samplerate=44100&#125;:rtp&#123;sdp=rtsp://:8554/test&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Client侧接受流-1"><a href="#2-Client侧接受流-1" class="headerlink" title="2. Client侧接受流"></a>2. Client侧接受流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc rtsp://172.16.1.1:8554/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="六-命令行操作方式（windows操作系统）——HTTP实现方式。"><a href="#六-命令行操作方式（windows操作系统）——HTTP实现方式。" class="headerlink" title="六. 命令行操作方式（windows操作系统）——HTTP实现方式。"></a>六. 命令行操作方式（windows操作系统）——HTTP实现方式。</h3><h3 id="1-Server侧打流-2"><a href="#1-Server侧打流-2" class="headerlink" title="1. Server侧打流"></a>1. Server侧打流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc -vvv sample1.avi --sout <span class="string">&quot;#transcode&#123;vcodec=h264,vb=0,scale=0,acodec=mpga,ab=128,channels=2,samplerate=44100&#125;:http&#123;mux=ffmpeg&#123;mux=flv&#125;,dst=:8080/test&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Client侧接受流-2"><a href="#2-Client侧接受流-2" class="headerlink" title="2. Client侧接受流"></a>2. Client侧接受流</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vlc http://172.16.1.1:8080/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/08/06/pacman%E7%AC%94%E8%AE%B0/">pacman笔记</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-08-06T07:32:41.000Z" itemprop="datePublished">2021-08-06</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/pacman/" rel="tag">pacman</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="更新系统"><a href="#更新系统" class="headerlink" title="更新系统"></a>更新系统</h2><p>在 Archlinux 中，使用一条命令即可对整个系统进行更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -Syyu</span><br></pre></td></tr></table></figure>
<p>如果你已经使用<code>pacman -Sy</code>将本地的包数据库与远程的仓库进行了同步，也可以只执行：<code>pacman -Su</code></p>
<h2 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pacman -S 包名 <span class="comment">#例如，执行 pacman -S firefox 将安装 Firefox。你也可以同时安装多个包，只需以空格分隔包名即可。</span></span><br><span class="line">pacman -Sy 包名 <span class="comment">#与上面命令不同的是，该命令将在同步包数据库后再执行安装。</span></span><br><span class="line">pacman -Sv 包名 <span class="comment">#在显示一些操作信息后执行安装。</span></span><br><span class="line">pacman -U <span class="comment">#安装本地包，其扩展名为 pkg.tar.gz。</span></span><br><span class="line">pacman -U http://www.example.com/repo/example.pkg.tar.xz 安装一个远程包（不在 pacman 配置的源里面）</span><br></pre></td></tr></table></figure>
<h2 id="删除包"><a href="#删除包" class="headerlink" title="删除包"></a>删除包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pacman -R 包名 <span class="comment">#该命令将只删除包，保留其全部已经安装的依赖关系</span></span><br><span class="line">pacman -Rs 包名 <span class="comment">#在删除包的同时，删除其所有没有被其他已安装软件包使用的依赖关系</span></span><br><span class="line">pacman -Rsc 包名 <span class="comment">#在删除包的同时，删除所有依赖这个软件包的程序</span></span><br><span class="line">pacman -Rd 包名 <span class="comment">#在删除包时不检查依赖。</span></span><br><span class="line">pacman -Rns 包名 <span class="comment">#删除包和它所有的依赖，还删掉它的全局配置文件</span></span><br><span class="line">pacman -R $(sudo pacman -Qdtq) <span class="comment">#查询孤儿软件并删除掉他们</span></span><br></pre></td></tr></table></figure>
<h2 id="搜索包"><a href="#搜索包" class="headerlink" title="搜索包"></a>搜索包</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pacman -Ss 关键字 <span class="comment">#在仓库中搜索含关键字的包。</span></span><br><span class="line">pacman -Qi 包名 <span class="comment">#查看有关包的详尽信息。</span></span><br><span class="line">pacman -Ql 包名 <span class="comment">#列出该包的文件。</span></span><br><span class="line">pacman -Q <span class="comment">#显示出所有软件 sudo pacman -Q | wc -l 查询数量</span></span><br><span class="line">pacman -Qe <span class="comment">#查询所有自己安装的软件</span></span><br><span class="line">pacman -Qeq <span class="comment">#查询所有自己安装的软件，只显示包名，不显示版本号等</span></span><br><span class="line">pacman -Qs &lt;pkg_name&gt; <span class="comment">#查询本地安装的所有带&lt;pkg_name&gt;的软件</span></span><br><span class="line">pacman -Qdt <span class="comment">#查询所有孤儿软件，不再被需要的。</span></span><br><span class="line">pacman -Qdtq <span class="comment">#查询所有不再被依赖的包名</span></span><br></pre></td></tr></table></figure>
<h2 id="其他用法"><a href="#其他用法" class="headerlink" title="其他用法"></a>其他用法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pacman -Sw 包名 <span class="comment">#只下载包，不安装。</span></span><br><span class="line">pacman -Sc <span class="comment">#清理未安装的包文件，包文件位于 /var/cache/pacman/pkg/ 目录。</span></span><br><span class="line">pacman -Scc <span class="comment">#删除/var目录下的缓存文件</span></span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/08/05/kernel%E8%BF%9B%E7%A8%8B%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6/">kernel进程读写文件</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-08-05T07:32:41.000Z" itemprop="datePublished">2021-08-05</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/IO/" rel="tag">IO</a>, <a class="article-tag-link" href="/tags/kernel/" rel="tag">kernel</a>, <a class="article-tag-link" href="/tags/linux/" rel="tag">linux</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>在kernel驱动程序中读写文件，没有标准库可用，需要用kernel提供的一些函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">filp_open()</span><br><span class="line">filp_close()</span><br><span class="line">vfs_read()</span><br><span class="line">vfs_write()</span><br><span class="line">set_fs()</span><br><span class="line">get_fs()</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="打开文件"><a href="#打开文件" class="headerlink" title="打开文件"></a>打开文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//filename: 表明要打开或创建文件的名称(包括路径部分)。需要先挂载文件系统再挂载驱动才能打开文件。</span></span><br><span class="line"><span class="comment">//open_mode: 打开方式，其取值与标准库中的open相应参数类似，可以取O_CREAT,O_RDWR,O_RDONLY等。</span></span><br><span class="line"><span class="comment">//mode: 创建文件时的默认权限</span></span><br><span class="line"><span class="comment">//返回strcut file*指针，供后继函数操作使用，返回值用IS_ERR(file)检测是否打开出错</span></span><br><span class="line"><span class="function">strcut file* <span class="title">filp_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">int</span> open_mode, <span class="keyword">int</span> mode)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数loff_t * pos所指向的值要初始化，表明从文件的什么地方开始读写。</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">vfs_read</span><span class="params">(struct file* filp, <span class="keyword">char</span> __user* buffer, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span>* pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">vfs_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user* buffer, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span>* pos)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这两个函数的第二个参数buffer，前面有<code>__user</code>修饰符，这就要求buffer指针应该指向用户空间的内存，如果传入kernel空间的指针，就会返回失败<code>-EFAULT</code></p>
<p>但在Kernel中，我们一般不容易生成用户空间的指针，或者不方便独立使用用户空间内存。想要使这两个读写函数使用kernel空间的buffer指针也能正确工作，就需要使用<code>set_fs()</code>宏/函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取kernel当前对内存地址检查的处理方式，默认情况下是USER_DS,即对用户空间地址检查并做变换。</span></span><br><span class="line"><span class="function"><span class="keyword">mm_segment_t</span> fs <span class="title">get_fs</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//改变kernel对内存地址检查的处理方式</span></span><br><span class="line"><span class="comment">//fs取值：USER_DS,KERNEL_DS 分别代表用户空间和内核空间</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_fs</span><span class="params">(<span class="keyword">mm_segment_t</span> fs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>要在对内存地址做检查变换的函数中使用内核空间地址，可以用<code>set_fs(KERNEL_DS)</code>进行设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mm_segment_t</span> old_fs = get_fs();</span><br><span class="line">set_fs(KERNEL_DS);</span><br><span class="line"></span><br><span class="line">vfs_read() <span class="function"><span class="keyword">or</span> <span class="title">vfs_write</span><span class="params">()</span> <span class="comment">//与内存有关的操作</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">set_fs</span><span class="params">(old_fs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>还有一些其它的内核函数参数也用<code>__user</code>修饰的参数，在kernel中需要用kernel空间的内存代替时，都可以使用类似办法。</p>
<h2 id="关闭文件"><a href="#关闭文件" class="headerlink" title="关闭文件"></a>关闭文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二个参数一般传递NULL值，也有用current-&gt;files作为实参的</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">filp_close</span><span class="params">(struct file*filp, <span class="keyword">fl_owner_t</span> id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>使用以上函数的其它注意点：</p>
<ol>
<li>其实Linux Kernel组成员不赞成在kernel中独立的读写文件(这样做可能会影响到策略和安全问题)，对内核需要的文件内容，最好由应用层配合完成。</li>
<li>在可加载的kernel module中使用这种方式读写文件可能使模块加载失败，原因是内核可能没有EXPORT你所需要的所有这些函数。</li>
<li>分析以上某些函数的参数可以看出，这些函数的正确运行需要依赖于进程环境，因此，有些函数不能在’中断的handle’或’Kernel中不属于任可进程的代码’中执行，否则可能出现崩溃，要避免这种情况发生，可以在kernel中创建内核线程，将这些函数放在线程环境下执行(创建内核线程的方式请参数kernel_thread()函数)。</li>
</ol>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/07/25/vnc/">vnc</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-07-25T09:53:52.000Z" itemprop="datePublished">2021-07-25</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/vnc/" rel="tag">vnc</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zh @ li in ~ [6:24:36]</span></span><br><span class="line">$ vncpasswd</span><br><span class="line">Password:</span><br><span class="line">Verify:</span><br><span class="line">Would you like to enter a view-only password (y/n)? n</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:25:59]</span></span><br><span class="line">$ sudo cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@\:1.service</span><br><span class="line">[sudo] zh 的密码：</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:28:23]</span></span><br><span class="line">$ sudo vim /etc/systemd/system/vncserver@:1.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:30:15]</span></span><br><span class="line">$ sudo vim /etc/systemd/system/vncserver@:1.service</span><br><span class="line">没有 systemd.Install 的手册页条目</span><br><span class="line">^[没有 systemd.Install 的手册页条目</span><br><span class="line">没有 systemd.Install 的手册页条目</span><br><span class="line">^[^[%</span><br><span class="line"><span class="comment"># zh @ li in ~ [6:39:48]</span></span><br><span class="line">$ systemctl start vncserver@:1.service</span><br><span class="line">Failed to start vncserver@:1.service: Access denied</span><br><span class="line">See system logs and <span class="string">&#x27;systemctl status vncserver@:1.service&#x27;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:40:44] C:4</span></span><br><span class="line">$ sudo systemctl start vncserver@:1.service</span><br><span class="line">[sudo] zh 的密码：</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:40:51]</span></span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> vncserver@:1.service</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/vncserver@:1.service → /etc/systemd/system/vncserver@:1.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:41:17]</span></span><br><span class="line">$ ls ~/.vnc</span><br><span class="line">passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:42:42]</span></span><br><span class="line">$ vncserver -list</span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:43:31] C:2</span></span><br><span class="line">$ vncserver -geometry 1920x1080</span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:44:18] C:2</span></span><br><span class="line">$ ls ~/.vnc</span><br><span class="line">passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:44:27]</span></span><br><span class="line">$ vncserver 1</span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:44:41] C:2</span></span><br><span class="line">$ vncserver display</span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:44:49] C:2</span></span><br><span class="line">$ vncserver --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:44:57] C:2</span></span><br><span class="line">$ netstat -pantu|grep vnc</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:45:37] C:1</span></span><br><span class="line">$ sudo netstat -pantu|grep vnc</span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:45:48] C:1</span></span><br><span class="line">$ vncserver</span><br><span class="line"></span><br><span class="line">usage: vncserver &lt;display&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zh @ li in ~ [6:48:16] C:2</span></span><br><span class="line">$ vncserver :1</span><br><span class="line">Using desktop session i3-with-shmlog</span><br><span class="line"></span><br><span class="line">New <span class="string">&#x27;li:1 (zh)&#x27;</span> desktop is li:1</span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/07/08/mysql%E7%AC%94%E8%AE%B0/">mysql笔记</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://humble-zh.github.io/page/2/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-07-08T07:32:41.000Z" itemprop="datePublished">2021-07-08</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/mysql/" rel="tag">mysql</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dzg_chat/article/details/88619120" title="Permalink to 【Mysql】Mysql常用指令（1）_dzg_chat的博客-CSDN博客">Source</a></p>
<p>学习过程参考视频教程：<a target="_blank" rel="noopener" href="http://www.java1234.com/a/yuanchuang/mysql/">java1234网站《一头扎进mysql》</a><br>源码及视频网盘：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1hrISqlm#list/path=/">链接</a></p>
<h2 id="0前言"><a href="#0前言" class="headerlink" title="0前言"></a>0前言</h2><p>数据库（Database）是按照数据结构来组织、存储和管理数据的仓库。</p>
<p>我们也可以将数据存储在文件中，但是在文件中读写数据速度相对较慢。</p>
<p>使用关系型数据库管理系统（RDBMS）来存储和管理的大数据量。所谓的关系型数据库，是建立在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。</p>
<p>RDBMS 即关系数据库管理系统(Relational Database Management System)的特点：</p>
<ul>
<li>1.数据以表格的形式出现</li>
<li>2.每行为各种记录名称</li>
<li>3.每列为记录名称所对应的数据域</li>
<li>4.许多的行和列组成一张表单</li>
<li>5.若干的表单组成database</li>
</ul>
<h2 id="1-mysql的数据类型简介"><a href="#1-mysql的数据类型简介" class="headerlink" title="1 mysql的数据类型简介"></a>1 mysql的数据类型简介</h2><h3 id="1-1-整数类型"><a href="#1-1-整数类型" class="headerlink" title="1.1 整数类型"></a>1.1 整数类型</h3><table>
<thead>
<tr>
<th align="center">整数类型</th>
<th align="center">字节数</th>
<th align="center">无符号(unsigned)范围</th>
<th align="center">有符号(signed)范围</th>
</tr>
</thead>
<tbody><tr>
<td align="center">TINYINT</td>
<td align="center">1</td>
<td align="center">0~255</td>
<td align="center">-128~127</td>
</tr>
<tr>
<td align="center">SMALLINT</td>
<td align="center">2</td>
<td align="center">0~65535</td>
<td align="center">-32768~32767</td>
</tr>
<tr>
<td align="center">MEDIUMINT</td>
<td align="center">3</td>
<td align="center">0~16777215</td>
<td align="center">-8388608~8388607</td>
</tr>
<tr>
<td align="center">INT</td>
<td align="center">4</td>
<td align="center">0~4294967295</td>
<td align="center">-2147483648~2147483647</td>
</tr>
<tr>
<td align="center">INTEGER</td>
<td align="center">4</td>
<td align="center">0~4294967295</td>
<td align="center">-2147483648~2147483647</td>
</tr>
<tr>
<td align="center">BIGINT</td>
<td align="center">8</td>
<td align="center">0~18446744073709551615</td>
<td align="center">-9223372036854775808~9223372036854775807</td>
</tr>
</tbody></table>
<p>INTEGER和INT是相同的，一般定义主键使用INT即可。默认是有符号情况，无符号要特别说明。</p>
<h3 id="1-2-浮点数和定点数类型"><a href="#1-2-浮点数和定点数类型" class="headerlink" title="1.2 浮点数和定点数类型"></a>1.2 浮点数和定点数类型</h3><p>浮点型在数据库中存放的是近似值，而定点类型在数据库中存放的是精确值。</p>
<p>数据类型精度有无符号的范围</p>
<ul>
<li>float(m,d)单精度浮点型，(4字节)，m总位数，d小数位10^38 级别</li>
<li>double(m,d)双精度浮点型，(8字节)，m总位数，d小数位10^308 级别</li>
<li>decimal(m,d)m&lt;65 是总个数，d&lt;30 且 d&lt;m 是小数位$1</li>
</ul>
<p>float32位中，有1位符号位，8位指数位，23位尾数位，实际的范围是-2128—2127，约为-3.4E38—3.4E38</p>
<p>double64位中，1位符号位，11位指数位，52位尾数位，范围约是-1.7E308—1.7E308</p>
<p>float和double精度问题：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/c-primer/p/5992696.html">参考博客</a></p>
<h3 id="1-3-日期与时间类型"><a href="#1-3-日期与时间类型" class="headerlink" title="1.3 日期与时间类型"></a>1.3 日期与时间类型</h3><p><img src="https://img-blog.csdnimg.cn/20190318230334824.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R6Z19jaGF0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>常用 DATA，TIME，DATATIME</p>
<h3 id="1-4-字符串类型"><a href="#1-4-字符串类型" class="headerlink" title="1.4 字符串类型"></a>1.4 字符串类型</h3><p>数据类型大小用途</p>
<ul>
<li>CHAR 0-255 字节定长字符串(实际分配的空间是固定的)</li>
<li>VARCHAR 0-65535 字节可变长字符串(实际分配空间根据字符存决定)</li>
<li>TEXT 0-65535 字节文本数据(TINYTEXT\LONGTEXT\MEDIUMTEXT)</li>
<li>ENUM枚举类型（只能取一个）</li>
<li>SET集合类型（可以取多个）</li>
</ul>
<h3 id="1-5-二进制类型"><a href="#1-5-二进制类型" class="headerlink" title="1.5 二进制类型"></a>1.5 二进制类型</h3><p><img src="https://img-blog.csdnimg.cn/20190318230352741.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R6Z19jaGF0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>存一些图片视频，一般存在web目录下读取快，存数据库慢。</p>
<h2 id="2-数据库（database）的基本操作"><a href="#2-数据库（database）的基本操作" class="headerlink" title="2 数据库（database）的基本操作"></a>2 数据库（database）的基本操作</h2><h3 id="2-1-数据库组件"><a href="#2-1-数据库组件" class="headerlink" title="2.1 数据库组件"></a>2.1 数据库组件</h3><ul>
<li>Mysql Shell：自带的一个高级的mysql命令行工具。</li>
<li>MySQL Workbench：为MySQL设计的ER/数据库建模工具，实现可视化管理数据库。</li>
<li>Mysql Command Line Client：MySQL的DOS界面，客户端工具。</li>
<li>Mysql Command Line Client-Unicode同上。</li>
<li>Mysqladmin：运维和管理工具</li>
</ul>
<p>退出Mysql：quit</p>
<h3 id="2-2-显示数据库"><a href="#2-2-显示数据库" class="headerlink" title="2.2 显示数据库"></a>2.2 显示数据库</h3><p>显示所有数据库：<code>show databases;</code></p>
<h3 id="2-3-创建数据库"><a href="#2-3-创建数据库" class="headerlink" title="2.3 创建数据库"></a>2.3 创建数据库</h3><p>创建数据库：<code>create database Name;</code> Name最好有一定规范，如db_book1</p>
<h3 id="2-4-删除数据库"><a href="#2-4-删除数据库" class="headerlink" title="2.4 删除数据库"></a>2.4 删除数据库</h3><p>删除数据库:<code>drop database Name;</code></p>
<h2 id="3-数据表（Tables）的基本操作"><a href="#3-数据表（Tables）的基本操作" class="headerlink" title="3 数据表（Tables）的基本操作"></a>3 数据表（Tables）的基本操作</h2><p>表是数据库存储数据的基本单位，一个表包含若干字段或记录。</p>
<h3 id="3-1-创建表"><a href="#3-1-创建表" class="headerlink" title="3.1 创建表"></a>3.1 创建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</span><br><span class="line">    属性名 数据类型 [完整性约束条件],</span><br><span class="line">    属性名 数据类型 [完整性约束条件],</span><br><span class="line">    .....</span><br><span class="line">    属性名 数据类型 [完整性约束条件],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>表的常见约束条件：</p>
<p><img src="https://img-blog.csdnimg.cn/20190318230414870.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R6Z19jaGF0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>创建图书类别表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use db_book;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_bookType(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span> auto_increment,</span><br><span class="line">    bookTypeName <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    bookTypeDesc <span class="type">varchar</span>(<span class="number">200</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>创建图书类型表：</p>
<p>并将图书的类别ID，做外键关联使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_book(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span> auto_increment,</span><br><span class="line">    bookname <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    author <span class="type">varchar</span>(<span class="number">10</span>),</span><br><span class="line">    price <span class="type">decimal</span>(<span class="number">6</span>,<span class="number">2</span>),</span><br><span class="line">    bookTypeId <span class="type">int</span>,</span><br><span class="line">    <span class="keyword">constraint</span> `fk` <span class="keyword">foreign</span> <span class="keyword">key</span>(`bookTypeId`) <span class="keyword">references</span> `t_booktype`(`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>若之前表已经存在了，则：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">Connect</span>(</span><br><span class="line">    con <span class="keyword">DOUBLE</span>,</span><br><span class="line">    nectid <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">Connect</span> <span class="keyword">add</span> <span class="keyword">constraint</span> `fkid` <span class="keyword">foreign</span> <span class="keyword">key</span>(`nectid`) <span class="keyword">references</span> `t_booktype`(`id`)</span><br></pre></td></tr></table></figure>
<p>注意这里的符号是数字1左侧英文输入状态下的 ` 不是单引号 ’</p>
<h3 id="3-2-查看表结构"><a href="#3-2-查看表结构" class="headerlink" title="3.2 查看表结构"></a>3.2 查看表结构</h3><p>查看基本表结构：<code>DESCRIBE/DESC 表名;</code></p>
<p>详细结构：<code>SHOW create table 表名;</code></p>
<p>显示本数据库内的所有表：<code>SHOW tables</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> t_booktype;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t_booktype;</span><br><span class="line"><span class="keyword">show</span> tables；</span><br></pre></td></tr></table></figure>
<h3 id="3-3-修改表结构"><a href="#3-3-修改表结构" class="headerlink" title="3.3 修改表结构"></a>3.3 修改表结构</h3><p><img src="https://img-blog.csdnimg.cn/20190318230444376.PNG" alt="在这里插入图片描述"></p>
<p>修改表名： <code>alter table t_book rename t_book2;</code></p>
<p>修改t_book表的bookName字段名为bookName2，数据类型为 varchar(20): <code>alter table t_book change bookName bookName2 varchar(20);</code></p>
<p>增加字段名: <code>alter table t_book add authorage varchar(10);</code></p>
<p>带约束增加</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#加到最前面一列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_book <span class="keyword">add</span> testField <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">first</span>;</span><br><span class="line">#加到指定属性后面</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t_book <span class="keyword">add</span> testField <span class="type">varchar</span>(<span class="number">10</span>) after author;</span><br></pre></td></tr></table></figure>
<p>删除字段名: <code>alter table t_book drop testField;</code></p>
<h3 id="3-4-删除表"><a href="#3-4-删除表" class="headerlink" title="3.4 删除表"></a>3.4 删除表</h3><p><code>drop table 表名;</code></p>
<p>有依赖关系的时候先删掉子表再删主表。</p>
<h2 id="4-表内容的相关操作"><a href="#4-表内容的相关操作" class="headerlink" title="4 表内容的相关操作"></a>4 表内容的相关操作</h2><p>先创建一个数据表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_student(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span> auto_increment,</span><br><span class="line">    stuName <span class="type">varchar</span>(<span class="number">60</span>),</span><br><span class="line">    age <span class="type">int</span>,</span><br><span class="line">    sex <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">    gradeName <span class="type">varchar</span>(<span class="number">60</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>插入数据： 注意里面是使用的<strong>单引号</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;张一&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大一&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">&#x27;张二&#x27;</span>,<span class="number">19</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大二&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大三&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">4</span>,<span class="string">&#x27;张四&#x27;</span>,<span class="number">21</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大四&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">5</span>,<span class="string">&#x27;张五&#x27;</span>,<span class="number">22</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大一&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">&#x27;张六&#x27;</span>,<span class="number">23</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大二&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">7</span>,<span class="string">&#x27;张七&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大三&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">8</span>,<span class="string">&#x27;张八&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;大四&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>或者后面多组：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> db_book.t_student (id,stuName,age,gender,gradeName) <span class="keyword">values</span> (<span class="number">9</span>,<span class="string">&#x27;张九&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;大二&#x27;</span>),(<span class="number">10</span>,<span class="string">&#x27;张十&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;大四&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>给表取别名：<code>表名 表别名</code></p>
<p><code>select * from t_book where id=1;</code> 等价 <code>select * from t_book tb where tb.id=1;</code></p>
<p>字段取别名：<code>属性 [AS] 属性别名</code></p>
<p><code>select tb.bookName [AS] tbNa from t_book tb where tb.id=1;</code></p>
<h3 id="4-1-查询表内字段"><a href="#4-1-查询表内字段" class="headerlink" title="4.1 查询表内字段"></a>4.1 查询表内字段</h3><h4 id="4-1-1-查询所有字段："><a href="#4-1-1-查询所有字段：" class="headerlink" title="4.1.1 查询所有字段："></a>4.1.1 查询所有字段：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名;</span><br><span class="line"><span class="keyword">select</span> id,stuName,age,gender,gradeName <span class="keyword">from</span> t_student; #顺序可调</span><br><span class="line">#<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 表名;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-2-查询指定字段："><a href="#4-1-2-查询指定字段：" class="headerlink" title="4.1.2 查询指定字段："></a>4.1.2 查询指定字段：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 指定字段<span class="number">1</span>,指定字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名;</span><br><span class="line"><span class="keyword">select</span> stuName,gender <span class="keyword">from</span> t_student;</span><br></pre></td></tr></table></figure>
<h4 id="4-1-3-where条件查询"><a href="#4-1-3-where条件查询" class="headerlink" title="4.1.3 where条件查询"></a>4.1.3 where条件查询</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件表达式;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">19</span>;</span><br></pre></td></tr></table></figure>
<p>指定条件删除字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-4-带in关键字查询"><a href="#4-1-4-带in关键字查询" class="headerlink" title="4.1.4 带in关键字查询"></a>4.1.4 带in关键字查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 [<span class="keyword">NOT</span>] <span class="keyword">IN</span> (元素<span class="number">1.</span>元素<span class="number">2</span>…)；</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">in</span> (<span class="number">18</span>,<span class="number">19</span>); #只能取这两个，不是范围</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">18</span>,<span class="number">19</span>);</span><br></pre></td></tr></table></figure>
<h3 id="4-1-5-带between-and的范围查询"><a href="#4-1-5-带between-and的范围查询" class="headerlink" title="4.1.5 带between and的范围查询"></a>4.1.5 带between and的范围查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 [<span class="keyword">NOT</span>] <span class="keyword">BETWEEN</span> 取值a <span class="keyword">AND</span> 取值b；</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">between</span> <span class="number">18</span> <span class="keyword">and</span> <span class="number">20</span>； #<span class="number">18</span> <span class="number">19</span> <span class="number">20</span> 都可以取，是范围</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">not</span> <span class="keyword">between</span> <span class="number">18</span> <span class="keyword">and</span> <span class="number">20</span>；</span><br></pre></td></tr></table></figure>
<h3 id="4-1-6-带like模糊查询"><a href="#4-1-6-带like模糊查询" class="headerlink" title="4.1.6 带like模糊查询"></a>4.1.6 带like模糊查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 [<span class="keyword">NOT</span>] <span class="keyword">LIKE</span> ‘字符串’;</span><br><span class="line">#&quot;%&quot;代表任意字符 <span class="string">&#x27;_&#x27;</span>代表单个字符，前后都可</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> stuName <span class="keyword">like</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> stuName <span class="keyword">like</span> <span class="string">&#x27;张三%&#x27;</span>; #带<span class="string">&#x27;张三&#x27;</span>开头的</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> stuName <span class="keyword">like</span> <span class="string">&#x27;张三_&#x27;</span>; #_只能占一个位。多个就写多个_ _</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> stuName <span class="keyword">like</span> <span class="string">&#x27;%张三%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-7-空值查询"><a href="#4-1-7-空值查询" class="headerlink" title="4.1.7 空值查询"></a>4.1.7 空值查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 字段 <span class="keyword">IS</span> [<span class="keyword">NOT</span>] <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">is</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age <span class="keyword">is</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-8-带and的多条件查询"><a href="#4-1-8-带and的多条件查询" class="headerlink" title="4.1.8 带and的多条件查询"></a>4.1.8 带and的多条件查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件表达式<span class="number">1</span> <span class="keyword">AND</span> 条件表达式<span class="number">2</span> <span class="keyword">AND</span> 条件表达式<span class="number">3</span> <span class="keyword">AND</span> ...</span><br><span class="line">#注意末尾是没有分号的</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> gradeName<span class="operator">=</span><span class="string">&#x27;大四&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-9-带or的多条件查询"><a href="#4-1-9-带or的多条件查询" class="headerlink" title="4.1.9 带or的多条件查询"></a>4.1.9 带or的多条件查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,字段<span class="number">3.</span>.. <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件表达式<span class="number">1</span> <span class="keyword">OR</span> 条件表达式<span class="number">2</span> <span class="keyword">OR</span> 条件表达式<span class="number">3</span> <span class="keyword">OR</span> ...</span><br><span class="line">#或，语句末尾也是无分号；</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age<span class="operator">=</span><span class="number">20</span> <span class="keyword">or</span> gradeName<span class="operator">=</span><span class="string">&#x27;大四&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-10-distinct去重复查询"><a href="#4-1-10-distinct去重复查询" class="headerlink" title="4.1.10 distinct去重复查询"></a>4.1.10 distinct去重复查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> <span class="keyword">distinct</span> 字段名 <span class="keyword">from</span> 表;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> age <span class="keyword">from</span> t_student;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-11-对查询结果排序"><a href="#4-1-11-对查询结果排序" class="headerlink" title="4.1.11 对查询结果排序"></a>4.1.11 对查询结果排序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2</span>,... <span class="keyword">from</span> 表名 <span class="keyword">order</span> <span class="keyword">by</span> 属性名 [<span class="keyword">ASC</span><span class="operator">|</span><span class="keyword">DESC</span>]</span><br><span class="line">#默认升序</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> age <span class="keyword">from</span> t_student <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-12-group-by-分组查询"><a href="#4-1-12-group-by-分组查询" class="headerlink" title="4.1.12 group by 分组查询"></a>4.1.12 group by 分组查询</h3><p><img src="https://img-blog.csdnimg.cn/20190318230618668.PNG" alt="在这里插入图片描述"></p>
<p>一般不单独使用，常和聚合函数一起使用，一定注意使用的时候各个符号。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#按age分组，看每个(岁数)组有哪些stuName,GROUP_CONCAT把所有stuName拼接</span><br><span class="line"><span class="keyword">select</span> age,GROUP_CONCAT(stuName) <span class="keyword">from</span> t_student <span class="keyword">group</span> <span class="keyword">by</span> age;</span><br><span class="line"></span><br><span class="line">#按age分组，看每个(岁数)组有多少个stuName</span><br><span class="line"><span class="keyword">select</span> age,<span class="built_in">COUNT</span>(age) <span class="keyword">from</span> t_student <span class="keyword">group</span> <span class="keyword">by</span> age;</span><br><span class="line"></span><br><span class="line">#按age分组，看每个(岁数)组有多少个stuName，只输出统计总数大于<span class="number">1</span>的</span><br><span class="line"><span class="keyword">select</span> age,<span class="built_in">COUNT</span>(age) <span class="keyword">from</span> t_student <span class="keyword">group</span> <span class="keyword">by</span> age <span class="keyword">having</span> <span class="built_in">count</span>(age)<span class="operator">&gt;</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#按age分组，看每个(岁数)组有多少个stuName，多加一行计算总和，若是文本为所有元素拼接</span><br><span class="line"><span class="keyword">select</span> age,<span class="built_in">COUNT</span>(age) <span class="keyword">from</span> t_student <span class="keyword">group</span> <span class="keyword">by</span> age <span class="keyword">with</span> <span class="keyword">rollup</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-13-limit-分页查询"><a href="#4-1-13-limit-分页查询" class="headerlink" title="4.1.13 limit 分页查询"></a>4.1.13 limit 分页查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">select</span> 字段<span class="number">1</span>,字段<span class="number">2.</span>.. <span class="keyword">from</span> 表名 limit 初始位置,记录数,</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student LIMIT <span class="number">0</span>,<span class="number">5</span>; #从第<span class="number">0</span>条开始查<span class="number">5</span>条</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_student LIMIT <span class="number">5</span>,<span class="number">5</span>; #从第<span class="number">5</span>条开始查<span class="number">5</span>条</span><br></pre></td></tr></table></figure>
<h2 id="4-2-使用聚合函数查询（统计）"><a href="#4-2-使用聚合函数查询（统计）" class="headerlink" title="4.2 使用聚合函数查询（统计）"></a>4.2 使用聚合函数查询（统计）</h2><p>先创建一个相关数据表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_garde(</span><br><span class="line">    <span class="type">int</span> <span class="keyword">primary</span> <span class="keyword">key</span> auto_increment,</span><br><span class="line">    stuName <span class="type">varchar</span>(<span class="number">60</span>),</span><br><span class="line">    course <span class="type">varchar</span>(<span class="number">50</span>),</span><br><span class="line">    score <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_garde (id,stuName,course,score) <span class="keyword">values</span></span><br><span class="line">    (<span class="number">1</span>,<span class="string">&#x27;张一一&#x27;</span>,<span class="string">&#x27;语文&#x27;</span>,<span class="number">88</span>),</span><br><span class="line">    (<span class="number">2</span>,<span class="string">&#x27;张一一&#x27;</span>,<span class="string">&#x27;数学&#x27;</span>,<span class="number">89</span>),</span><br><span class="line">    (<span class="number">3</span>,<span class="string">&#x27;张一一&#x27;</span>,<span class="string">&#x27;英语&#x27;</span>,<span class="number">90</span>),</span><br><span class="line">    (<span class="number">4</span>,<span class="string">&#x27;张三三&#x27;</span>,<span class="string">&#x27;语文&#x27;</span>,<span class="number">92</span>),</span><br><span class="line">    (<span class="number">5</span>,<span class="string">&#x27;张三三&#x27;</span>,<span class="string">&#x27;数学&#x27;</span>,<span class="number">93</span>),</span><br><span class="line">    (<span class="number">6</span>,<span class="string">&#x27;张三三&#x27;</span>,<span class="string">&#x27;英语&#x27;</span>,<span class="number">94</span>),</span><br><span class="line">    (<span class="number">7</span>,<span class="string">&#x27;张五五&#x27;</span>,<span class="string">&#x27;语文&#x27;</span>,<span class="number">76</span>),</span><br><span class="line">    (<span class="number">8</span>,<span class="string">&#x27;张五五&#x27;</span>,<span class="string">&#x27;数学&#x27;</span>,<span class="number">78</span>),</span><br><span class="line">    (<span class="number">9</span>,<span class="string">&#x27;张五五&#x27;</span>,<span class="string">&#x27;英语&#x27;</span>,<span class="number">80</span>);</span><br></pre></td></tr></table></figure>
<h3 id="4-2-1-COUNT-函数"><a href="#4-2-1-COUNT-函数" class="headerlink" title="4.2.1 COUNT() 函数"></a>4.2.1 COUNT() 函数</h3><p><img src="https://img-blog.csdnimg.cn/20190318230646588.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">from</span> t_grade; #统计t_grade表内总共有多少条目</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> total <span class="keyword">from</span> t_grade; #统计t_grade表内总共有多少条目,并把列名 <span class="built_in">count</span>(<span class="operator">*</span>) 改为 total</span><br><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">from</span> t_grade <span class="keyword">group</span> <span class="keyword">by</span> stuName; #按stuName分组，看每个(stuName)组有多少条</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-SUM-函数"><a href="#4-2-2-SUM-函数" class="headerlink" title="4.2.2 SUM() 函数"></a>4.2.2 SUM() 函数</h3><p><img src="https://img-blog.csdnimg.cn/20190318230715268.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">SUM</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">where</span> stuName<span class="operator">=</span><span class="string">&#x27;张一一&#x27;</span>; #求某个学生的总分</span><br><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">SUM</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">group</span> <span class="keyword">by</span> stuName; #按stuName分组，看每个(stuName)组的各score总和</span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-AVG-函数"><a href="#4-2-3-AVG-函数" class="headerlink" title="4.2.3 AVG() 函数"></a>4.2.3 AVG() 函数</h3><p><img src="https://img-blog.csdnimg.cn/20190318230726348.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">AVG</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">where</span> stuName<span class="operator">=</span><span class="string">&#x27;张一一&#x27;</span>; #求某个学生的总分</span><br><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">AVG</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">group</span> <span class="keyword">by</span> stuName; #按stuName分组，看每个(stuName)组的平均score</span><br></pre></td></tr></table></figure>
<h3 id="4-2-4-MAX-函数"><a href="#4-2-4-MAX-函数" class="headerlink" title="4.2.4 MAX() 函数"></a>4.2.4 MAX() 函数</h3><p><img src="https://img-blog.csdnimg.cn/20190318230738747.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> stuName,course,<span class="built_in">MAX</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">where</span> stuName<span class="operator">=</span><span class="string">&#x27;张一一&#x27;</span>; #求某个学生的最高score,并列出course</span><br><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">MAX</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">group</span> <span class="keyword">by</span> stuName; #按stuName分组，看每个(stuName)组的最高score #分组前面属性只能写一个属性</span><br></pre></td></tr></table></figure>
<h3 id="4-2-5-MIN-函数"><a href="#4-2-5-MIN-函数" class="headerlink" title="4.2.5 MIN() 函数"></a>4.2.5 MIN() 函数</h3><p><img src="https://img-blog.csdnimg.cn/20190318230749316.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> stuName,course,<span class="built_in">MIN</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">where</span> stuName<span class="operator">=</span><span class="string">&#x27;张一一&#x27;</span>; #求某个学生的最低score,并列出course</span><br><span class="line"><span class="keyword">select</span> stuName,<span class="built_in">MIN</span>(score) <span class="keyword">from</span> t_grade <span class="keyword">group</span> <span class="keyword">by</span> stuName; #按stuName分组，看每个(stuName)组的最低score #分组前面属性只能写一个属性</span><br></pre></td></tr></table></figure>
<h2 id="4-3-多表连接查询"><a href="#4-3-多表连接查询" class="headerlink" title="4.3 多表连接查询"></a>4.3 多表连接查询</h2><p>将两个或两个以上的表按照某个条件连接起来，从中选取需要的数据。</p>
<h3 id="4-3-1-内连接查询"><a href="#4-3-1-内连接查询" class="headerlink" title="4.3.1 内连接查询"></a>4.3.1 内连接查询</h3><p>可以查询两个或两个以上的表，最常用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book,t_bookType; #数量取两表笛卡尔乘积(两两组合)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book,t_bookType <span class="keyword">where</span> t_book.bookTypeId<span class="operator">=</span>t_booktype.id; #数量取两表笛卡尔乘积后，看bookTypeId与id相等的条目</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> bookName,author,bookTypeName <span class="keyword">from</span> t_book,t_bookType <span class="keyword">where</span> t_book.bookTypeId<span class="operator">=</span>t_booktype.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb.bookName,tb.author,tby.bookTypeName <span class="keyword">from</span> t_book tb,t_bookType tby <span class="keyword">where</span> tb.bookTypeId<span class="operator">=</span>tby.id; #设置别名，防止多表字段名有重合</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-外连接查询"><a href="#4-3-2-外连接查询" class="headerlink" title="4.3.2 外连接查询"></a>4.3.2 外连接查询</h3><p>外链接可以查询某一张表的所有信息，就是把一张表不全的部分补进来，left right决定谁合并到谁之中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> 属性列表 <span class="keyword">from</span> 表名<span class="number">1</span> <span class="keyword">left</span><span class="operator">|</span><span class="keyword">right</span> <span class="keyword">join</span> 表名<span class="number">2</span> <span class="keyword">on</span> 表<span class="number">1.</span>属性<span class="number">1</span><span class="operator">=</span>表<span class="number">2.</span>属性<span class="number">2</span></span><br><span class="line">#<span class="keyword">left</span>连接把表<span class="number">1</span>所有属性列出来加上表<span class="number">2</span>匹配的条目，<span class="keyword">right</span>连接吧表<span class="number">2</span>所有属性列出来加上表<span class="number">1</span>匹配的条目。空值<span class="keyword">NULL</span>，<span class="keyword">on</span>限制条件。</span><br></pre></td></tr></table></figure>
<p>1、左连接查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">left</span> <span class="keyword">join</span> t_booktype <span class="keyword">on</span> t_book.bookTypeId<span class="operator">=</span>t_booktype.id; #显示表t_book所有属性</span><br></pre></td></tr></table></figure>
<p>2、右连接查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tb.bookName,tb.author,tby.bookTypeName <span class="keyword">from</span> t_book tb <span class="keyword">right</span> <span class="keyword">join</span> t_bookType tby <span class="keyword">on</span> tb.bookTypeId<span class="operator">=</span>tby.id;</span><br><span class="line">#显示表t_bookType全部属性，推荐使用别名。</span><br></pre></td></tr></table></figure>
<h3 id="4-3-3-多条件查询"><a href="#4-3-3-多条件查询" class="headerlink" title="4.3.3 多条件查询"></a>4.3.3 多条件查询</h3><p>多个条件之间使用AND连接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tb.bookName,tb.author,tby.bookTypeName <span class="keyword">from</span> t_book tb,t_bookType tby <span class="keyword">where</span> tb.bookTypeId<span class="operator">=</span>tby.id <span class="keyword">AND</span> price<span class="operator">&gt;</span><span class="number">70</span>;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-子查询"><a href="#4-4-子查询" class="headerlink" title="4.4 子查询"></a>4.4 子查询</h2><p>在表2中进行查询，查询的某属性是限定在表一的条件中的。</p>
<h3 id="4-4-1-带IN关键字的子查询"><a href="#4-4-1-带IN关键字的子查询" class="headerlink" title="4.4.1 带IN关键字的子查询"></a>4.4.1 带IN关键字的子查询</h3><p>一个查询语句的条件可能落在另一个SELECT语句的查询结果中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> bookTypeID [<span class="keyword">NOT</span>] <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">in</span> t_booktype);</span><br><span class="line">#选择表t_book的所有属性显示，筛选bookTypeID 在表t_booktype里的</span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-带比较运算条件的子查询"><a href="#4-4-2-带比较运算条件的子查询" class="headerlink" title="4.4.2 带比较运算条件的子查询"></a>4.4.2 带比较运算条件的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> price <span class="operator">&gt;=</span> (<span class="keyword">select</span> price <span class="keyword">from</span> t_pricelevel <span class="keyword">where</span> pricelevel<span class="operator">=</span><span class="number">1</span>);</span><br><span class="line">#后面括号筛选完成的条件要是数字，不是集合</span><br></pre></td></tr></table></figure>
<h3 id="4-4-3-带Exits关键字的子查询"><a href="#4-4-3-带Exits关键字的子查询" class="headerlink" title="4.4.3 带Exits关键字的子查询"></a>4.4.3 带Exits关键字的子查询</h3><p>判断性质：假如子查询语句查询到记录则进行外层查询，子查询为空不执行外层查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> [<span class="keyword">NOT</span>] EXITS (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_booktype);</span><br><span class="line">#后面括号筛选得到空，则不执行前面的查询</span><br></pre></td></tr></table></figure>
<h3 id="4-4-4-带ANY关键字的子查询"><a href="#4-4-4-带ANY关键字的子查询" class="headerlink" title="4.4.4 带ANY关键字的子查询"></a>4.4.4 带ANY关键字的子查询</h3><p>满足任一条件即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> price <span class="operator">&gt;=</span> <span class="keyword">any</span> (<span class="keyword">select</span> price <span class="keyword">from</span> t_pricelevel);</span><br><span class="line">#后面括号筛选完成的条件是集合</span><br></pre></td></tr></table></figure>
<h3 id="4-4-5-带ALL关键字的子查询"><a href="#4-4-5-带ALL关键字的子查询" class="headerlink" title="4.4.5 带ALL关键字的子查询"></a>4.4.5 带ALL关键字的子查询</h3><p>满足所有条件。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> price <span class="operator">&gt;=</span> <span class="keyword">all</span> (<span class="keyword">select</span> price <span class="keyword">from</span> t_pricelevel);</span><br><span class="line">#后面括号筛选完成的条件是集合</span><br></pre></td></tr></table></figure>
<h2 id="4-5-合并查询"><a href="#4-5-合并查询" class="headerlink" title="4.5 合并查询"></a>4.5 合并查询</h2><p>使用UNION关键字将所有查询结果合并到一起，去除相同记录。UNION ALL不去除重复记录。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> t_book; #(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> t_booktype; #(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> t_book <span class="keyword">UNION</span> <span class="keyword">select</span> id <span class="keyword">from</span> t_booktype; #(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>)</span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> t_book <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">select</span> id <span class="keyword">from</span> t_booktype; #(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<h2 id="4-6-插入、更新、删除数据"><a href="#4-6-插入、更新、删除数据" class="headerlink" title="4.6 插入、更新、删除数据"></a>4.6 插入、更新、删除数据</h2><h3 id="4-6-1-插入"><a href="#4-6-1-插入" class="headerlink" title="4.6.1 插入"></a>4.6.1 插入</h3><p>所有字段插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">insert</span> <span class="keyword">into</span> 表名 <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2</span>,值<span class="number">3.</span>..);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_book <span class="keyword">values</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;围城&#x27;</span>,,<span class="string">&#x27;钱钟书&#x27;</span>,<span class="number">1</span>)；</span><br><span class="line">#自增的属性可以设为<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>
<p>指定字段插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">insert</span> <span class="keyword">into</span> 表名(属性<span class="number">1</span>,属性<span class="number">2</span>,属性n) <span class="keyword">values</span>(值<span class="number">1</span>,值<span class="number">2</span>,值<span class="number">3.</span>..);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_book(id,bookName,price,author,bookTypeId) <span class="keyword">values</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;围城&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;钱钟书&#x27;</span>,<span class="number">1</span>)；</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_book(bookName,author) <span class="keyword">values</span>(<span class="string">&#x27;围城&#x27;</span>,<span class="string">&#x27;钱钟书&#x27;</span>)； #也可以取指定的属性插入，其他默认为<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>
<p>同时插入多条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">insert</span> <span class="keyword">into</span> 表名[(属性列表)] <span class="keyword">values</span> (取值列表<span class="number">1</span>),(取值列表<span class="number">2</span>),...(取值列表n);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_book(id,bookName,price,author,bookTypeId) <span class="keyword">values</span> (<span class="keyword">NULL</span>,<span class="string">&#x27;围城2&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;钱钟书&#x27;</span>,<span class="number">1</span>),(<span class="keyword">NULL</span>,<span class="string">&#x27;围城3&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;钱钟书&#x27;</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h3 id="4-6-2-更新"><a href="#4-6-2-更新" class="headerlink" title="4.6.2 更新"></a>4.6.2 更新</h3><p>表里的一些属性值发生了变化，及时更新</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">update</span> 表名 <span class="keyword">set</span> 属性<span class="number">1</span> <span class="operator">=</span>取值<span class="number">1</span>,属性<span class="number">2</span><span class="operator">=</span>取值<span class="number">2.</span>..属性n<span class="operator">=</span>取值n <span class="keyword">where</span> 条件表达式;</span><br><span class="line"><span class="keyword">update</span> t_book <span class="keyword">set</span> bookName<span class="operator">=</span><span class="string">&#x27;围城&#x27;</span>,price<span class="operator">=</span><span class="number">40</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">5</span>; #逗号分隔</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t_book <span class="keyword">set</span> bookName<span class="operator">=</span><span class="string">&#x27;钱钟书的书&#x27;</span> <span class="keyword">where</span> <span class="keyword">like</span> <span class="string">&#x27;%围%&#x27;</span>；</span><br><span class="line">#使用模糊查询，将表中含有 围 字书名的书全部改为 钱钟书的书</span><br></pre></td></tr></table></figure>
<h3 id="4-6-3-删除"><a href="#4-6-3-删除" class="headerlink" title="4.6.3 删除"></a>4.6.3 删除</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">delete</span> <span class="keyword">from</span> 表名 <span class="keyword">where</span> [条件表达式]</span><br><span class="line">#条件不是主键可能会报错，需要百度修改数据库模式。</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t_book <span class="keyword">where</span> id<span class="operator">=</span><span class="number">6</span>; #删除一条</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age<span class="operator">&gt;=</span><span class="number">20</span>; #符合条件多条</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t_student <span class="keyword">where</span> age<span class="operator">=</span><span class="string">&#x27;2%&#x27;</span>; #错误，非字符串不能这么匹配</span><br></pre></td></tr></table></figure>
<h2 id="5-索引"><a href="#5-索引" class="headerlink" title="5.索引"></a>5.索引</h2><p>索引类似图书的目录，方便快速定位，查找指定内容，提高查询速度。</p>
<p>索引是数据库的一个对象，数据库中的一列或者多列组成，它不能独立存在，必须对某个表对象进行依赖。</p>
<p>索引保存在information_schema数据库里的STATISTICS表中。</p>
<ul>
<li>优点：提高查询数据的速度</li>
<li>缺点：创建和维护索引的时间增加了</li>
</ul>
<h3 id="5-1-索引分类"><a href="#5-1-索引分类" class="headerlink" title="5.1 索引分类"></a>5.1 索引分类</h3><p>查看数据库 db_book 内所有索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.`innodb_index_stats` a <span class="keyword">where</span> a.`database_name` <span class="operator">=</span> <span class="string">&#x27;db_book&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>查看当前table的索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> tableName;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190319091846612.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R6Z19jaGF0,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="5-2-创建索引"><a href="#5-2-创建索引" class="headerlink" title="5.2 创建索引"></a>5.2 创建索引</h3><p>创建的关键字 <strong>INDEX</strong></p>
<p>一般主键在创建时默认就是唯一性索引。</p>
<p>方法1：最开始创建表的时候添加索引：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319092027228.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#普通 单列 索引</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_u1(id <span class="type">int</span>, uName <span class="type">varchar</span>(<span class="number">20</span>), password <span class="type">varchar</span>(<span class="number">20</span>), INDEX (uName));</span><br><span class="line"></span><br><span class="line">#唯一性单列索引  注意对应位置含义</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_u2(id <span class="type">int</span>, uName <span class="type">varchar</span>(<span class="number">20</span>), password <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">UNIQUE</span> INDEX (uName));</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_u2(id <span class="type">int</span>, uName <span class="type">varchar</span>(<span class="number">20</span>), password <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">UNIQUE</span> INDEX index_uName(uName)); #带别名</span><br><span class="line"></span><br><span class="line">#全文单列索引</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_u2(id <span class="type">int</span>, uName <span class="type">varchar</span>(<span class="number">20</span>), password <span class="type">varchar</span>(<span class="number">20</span>), FULLTEXT INDEX (uName));</span><br><span class="line"></span><br><span class="line">#多列索引，uName,password两列属性指向一个索引</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_u3(id <span class="type">int</span>, uName <span class="type">varchar</span>(<span class="number">20</span>), password <span class="type">varchar</span>(<span class="number">20</span>), INDEX index_uName_password(uName,password));</span><br></pre></td></tr></table></figure>
<p>方法2：为已经存在的表添加索引：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319092252629.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> INDEX index_uName <span class="keyword">ON</span> t_u4(uName); #新增普通单列索引</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">UNIQUE</span> INDEX index_uName <span class="keyword">ON</span> t_u4(uName); #新增唯一性单列索引</span><br><span class="line"><span class="keyword">create</span> INDEX index_uName_password <span class="keyword">ON</span> t_u4(uName,password); #新增多列索引</span><br></pre></td></tr></table></figure>
<p>方法3：使用alter方法创建索引：</p>
<p><img src="https://img-blog.csdnimg.cn/201903190923342.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">TABLE</span> t_u5 <span class="keyword">ADD</span> INDEX index_uName(uName); #新增普通单列索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">TABLE</span> t_u5 <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> INDEX index_uName(uName); #新增唯一性单列索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">TABLE</span> t_u5 <span class="keyword">ADD</span> INDEX index_uName_password(uName,password); #新增多列索引</span><br></pre></td></tr></table></figure>
<h3 id="5-3-删除索引"><a href="#5-3-删除索引" class="headerlink" title="5.3 删除索引"></a>5.3 删除索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">DROP</span> INDEX 索引名 <span class="keyword">ON</span> 表名;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> INDEX index_userName <span class="keyword">ON</span> t_u5;</span><br><span class="line"><span class="keyword">DROP</span> INDEX index_userName_password <span class="keyword">ON</span> t_u5; #删除多列索引</span><br></pre></td></tr></table></figure>
<h2 id="6-数据库视图（View）"><a href="#6-数据库视图（View）" class="headerlink" title="6 数据库视图（View）"></a>6 数据库视图（View）</h2><ul>
<li>视图是从一个或几个基本表（或视图）中导出的虚拟的表。</li>
<li>视图是从一个或多个实际表中获得的，那些用于产生视图的表叫做该视图的基表。在系统的数据字典中仅存放了视图的定义，不存放对应的数据，通过视图看到的数据存放在基表中。</li>
<li>通过视图修改数据时，实际上是在改变基表中的数据；相反地，基表数据的改变也会自动反映在由基表产生的视图中。</li>
<li>由于逻辑上的原因，有些视图可以修改对应的基表，而有些则不能（仅仅能查询）。</li>
</ul>
<h3 id="6-1-视图的好处"><a href="#6-1-视图的好处" class="headerlink" title="6.1 视图的好处"></a>6.1 视图的好处</h3><ul>
<li>提高重用性，针对重复使用的属性字段；</li>
<li>增强安全性，不同权限用户使用部分数据创建的对应视图；</li>
<li>表的逻辑独立性。</li>
</ul>
<p>可参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sustudy/p/4166714.html">博客</a></p>
<h3 id="6-2-创建视图"><a href="#6-2-创建视图" class="headerlink" title="6.2 创建视图"></a>6.2 创建视图</h3><p><img src="https://img-blog.csdnimg.cn/20190319105348206.PNG" alt="在这里插入图片描述"></p>
<p>ALGORITHM表示视图选择的算法（可选参数）</p>
<ul>
<li>UNDEFINED：MySQL将自动选择所要使用的算法</li>
<li>MERGE：将视图的语句与视图定义合并起来，使得视图定义的某一部分取代语句的对应部分</li>
<li>TEMPTABLE：将视图的结果存入临时表，然后使用临时表执行语句</li>
</ul>
<p>WITH CHECK OPTION表示更新视图时要保证在该试图的权限范围之内（可选参数）</p>
<h4 id="6-2-1-单表视图"><a href="#6-2-1-单表视图" class="headerlink" title="6.2.1 单表视图"></a>6.2.1 单表视图</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_book; #用t_book所有字段生成视图v1</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v1; #查看视图v1的所有的字段属性</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v2 <span class="keyword">AS</span> <span class="keyword">SELECT</span> bookName,price <span class="keyword">FROM</span> t_book; #用t_book的bookName,price字段生成视图v2</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v3(b,p) <span class="keyword">AS</span> <span class="keyword">SELECT</span> bookName,price <span class="keyword">FROM</span> t_book; #创建的视图内将bookName和price字段重命名为 b 和 p</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v3;</span><br></pre></td></tr></table></figure>
<h4 id="6-2-2-多表视图"><a href="#6-2-2-多表视图" class="headerlink" title="6.2.2 多表视图"></a>6.2.2 多表视图</h4><p><strong>同一个数据库下不同表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v4 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table1) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> table2); #合并查询</span><br></pre></td></tr></table></figure>
<p>或：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v5 <span class="keyword">as</span> <span class="keyword">select</span> bookName,bookTypeName <span class="keyword">from</span> t_book,t_booktype <span class="keyword">where</span> t_book.bookTypeID<span class="operator">=</span>t_booktype.id;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v5 <span class="keyword">AS</span> <span class="keyword">SELECT</span> tb.bookName,tby.bookTypeName <span class="keyword">FROM</span> t_book tb,t_booktype tby <span class="keyword">WHERE</span> tb.bookTypeId<span class="operator">=</span>tby.id; #从两张取了别名的表里按指定条件创建视图</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v5;</span><br></pre></td></tr></table></figure>
<p><strong>不同数据库下的不同表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#在数据库<span class="number">1</span> 目录下创建</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 数据库<span class="number">1.</span>v <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 数据库<span class="number">1.</span>table1) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 数据库<span class="number">2.</span>table2);</span><br><span class="line"></span><br><span class="line">#在数据库<span class="number">2</span> 目录下创建</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 数据库<span class="number">2.</span>v <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 数据库<span class="number">1.</span>table1) <span class="keyword">union</span> <span class="keyword">all</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 数据库<span class="number">2.</span>table2);</span><br></pre></td></tr></table></figure>
<h3 id="6-3-查看视图"><a href="#6-3-查看视图" class="headerlink" title="6.3 查看视图"></a>6.3 查看视图</h3><p>通过指令或数据库图形管理工具查看。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> view1; #基本的视图内容信息：字段名、类型等</span><br><span class="line"></span><br><span class="line"># 查看状态信息：包含创建时间，一些虚拟状态值</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;view1&#x27;</span>; #视图是虚表，所以没有<span class="keyword">collation</span>之类的信息</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;t_book&#x27;</span>; #t_book是表，有<span class="keyword">collation</span>之类的信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> view1; #详细信息，包括编码，建表语句等</span><br></pre></td></tr></table></figure>
<h3 id="6-4-修改视图"><a href="#6-4-修改视图" class="headerlink" title="6.4 修改视图"></a>6.4 修改视图</h3><p>方法1：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319121857494.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#视图v1有<span class="number">4</span>个字段，改为只有bookName和price</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> v1(bookName,price) <span class="keyword">AS</span> <span class="keyword">SELECT</span> bookName,price <span class="keyword">FROM</span> t_book;</span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319121906237.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#视图v1只有bookName和price，改为t_book所有的字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> v1 <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_book;</span><br></pre></td></tr></table></figure>
<h3 id="6-5-更新视图"><a href="#6-5-更新视图" class="headerlink" title="6.5 更新视图"></a>6.5 更新视图</h3><ul>
<li>通过视图来插入、更新、删除表中的<strong>数据</strong>。</li>
<li>视图只是一个虚表，没有数据，操作的是识图来源的<strong>基表</strong></li>
<li>更新视图要在权限范围内。</li>
</ul>
<h4 id="6-5-1-插入视图（数据）"><a href="#6-5-1-插入视图（数据）" class="headerlink" title="6.5.1 插入视图（数据）"></a>6.5.1 插入视图（数据）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#视图v1有id,bookName,price,author,bookTypeID</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> v1 <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;java good&#x27;</span>,<span class="number">120</span>,<span class="string">&#x27;feng&#x27;</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h4 id="6-5-2-更新视图（数据）"><a href="#6-5-2-更新视图（数据）" class="headerlink" title="6.5.2 更新视图（数据）"></a>6.5.2 更新视图（数据）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> v1 <span class="keyword">SET</span> bookName<span class="operator">=</span><span class="string">&#x27;java very good&#x27;</span>,price<span class="operator">=</span><span class="number">200</span> <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h4 id="6-5-3-删除视图（数据）"><a href="#6-5-3-删除视图（数据）" class="headerlink" title="6.5.3 删除视图（数据）"></a>6.5.3 删除视图（数据）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> v1 <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h3 id="6-6-删除视图"><a href="#6-6-删除视图" class="headerlink" title="6.6 删除视图"></a>6.6 删除视图</h3><p>删除数据库中已经存在的视图，删除视图并不会删除数据，只是删除视图定义。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> IF <span class="keyword">EXISTS</span> view1;</span><br></pre></td></tr></table></figure>
<h2 id="7-触发器（TRIGGER）"><a href="#7-触发器（TRIGGER）" class="headerlink" title="7 触发器（TRIGGER）"></a>7 触发器（TRIGGER）</h2><p>执行某项操作（INSERT、UPDATE、DELETE）时候自动触发执行预设好的相对应操作。</p>
<p>如在表a添加数据时表b里的对应属性也进行一个变化。</p>
<p>相同的表相同的操作只能创建一个对应的触发器。</p>
<h3 id="7-1-创建使用触发器"><a href="#7-1-创建使用触发器" class="headerlink" title="7.1 创建使用触发器"></a>7.1 创建使用触发器</h3><p>单个执行语句的触发器：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319143423985.PNG" alt="在这里插入图片描述"></p>
<p>注意执行语句where 后面的部分old和new</p>
<ul>
<li>old表示插入之前的值，old用在删除和修改</li>
<li>new表示新插入的值，new用在添加、更新和修改</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#创建<span class="keyword">trigger</span>：在<span class="keyword">insert</span>插入新数据操作之后 更新书的数量 <span class="keyword">new</span>表示插入的条目</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trig_book AFTER <span class="keyword">INSERT</span></span><br><span class="line">    <span class="keyword">ON</span> t_book <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">        <span class="keyword">UPDATE</span> t_bookType <span class="keyword">SET</span> bookNum<span class="operator">=</span>bookNum<span class="operator">+</span><span class="number">1</span> <span class="keyword">WHERE</span> new.bookTypeId<span class="operator">=</span>t_booktype.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_book <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;java好&#x27;</span>,<span class="number">100</span>,<span class="string">&#x27;ke&#x27;</span>,<span class="number">1</span>); #插入操作触发<span class="keyword">trigger</span></span><br></pre></td></tr></table></figure>
<p>多条执行语句：</p>
<p><img src="https://img-blog.csdnimg.cn/20190319143439304.PNG" alt="在这里插入图片描述"></p>
<p>默认mysql是遇到一个分号 ； 执行一次的。</p>
<p>DELIMITER | 是告诉mysql解释器不要将多条程序体里面单条语句的分号 ；直接执行，是作为一个程序体的。也可以使用 $$ // 等表示</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yuxin6866/article/details/52722913">厚积_薄发博客</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#创建触发器</span><br><span class="line">DELIMITER <span class="operator">|</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trig_book2 AFTER <span class="keyword">DELETE</span></span><br><span class="line">    <span class="keyword">ON</span> t_book <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> t_bookType <span class="keyword">SET</span> bookNum<span class="operator">=</span>bookNum<span class="number">-1</span> <span class="keyword">WHERE</span> old.bookTypeId<span class="operator">=</span>t_booktype.id;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_log <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,NOW(),<span class="string">&#x27;在book表里删除了一条数据&#x27;</span>); #mysql里NOW（）表示当前时间</span><br><span class="line">        <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_test <span class="keyword">WHERE</span> old.bookTypeId<span class="operator">=</span>t_test.id; #顺便把t_test的一条也删掉</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">|</span></span><br><span class="line">DELIMITER;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_book <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">5</span>; #删除操作触发<span class="keyword">trigger</span></span><br></pre></td></tr></table></figure>
<p>上面函数的作用是：当删除 <code>t_book</code> 里面 id=5的数据时，触发在</p>
<ul>
<li>给<code>t_bookType</code> 表中 bookNum数量-1</li>
<li>在日志表 <code>t_log</code> 中加入一条记录</li>
<li>在测试表 <code>t_test</code> 里面删除了和之前记录id相等的数据 <code>old.bookTypeId=t_test.id</code></li>
</ul>
<h3 id="7-2-查看触发器状态"><a href="#7-2-查看触发器状态" class="headerlink" title="7.2 查看触发器状态"></a>7.2 查看触发器状态</h3><p>查看触发器的状态：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TRIGGERS; #列出来所有的</span><br></pre></td></tr></table></figure>
<h3 id="7-3-删除触发器"><a href="#7-3-删除触发器" class="headerlink" title="7.3 删除触发器"></a>7.3 删除触发器</h3><p>注意结束符号 ；之前是否有空格或者全半角区别，可能引起错误。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> trig_book ;</span><br></pre></td></tr></table></figure>
<p>触发器补充介绍：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012964753/article/details/81175631">硕果累累的博客</a></p>
<h2 id="8-函数（functions）"><a href="#8-函数（functions）" class="headerlink" title="8 函数（functions）"></a>8 函数（functions）</h2><h3 id="8-1-常用函数"><a href="#8-1-常用函数" class="headerlink" title="8.1 常用函数"></a>8.1 常用函数</h3><h4 id="8-1-1-日期和时间函数"><a href="#8-1-1-日期和时间函数" class="headerlink" title="8.1.1 日期和时间函数"></a>8.1.1 日期和时间函数</h4><p>获取当前时间的<strong>语句</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> now();</span><br><span class="line"><span class="keyword">select</span> sysdate();</span><br><span class="line"></span><br><span class="line">获取日期时间的各个部分：日期、时间、年、季度、月、日、小时、分钟、秒</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="variable">@test</span><span class="operator">=</span><span class="string">&#x27;2019-03-26 23:08:12.123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="type">date</span>(<span class="variable">@test</span>); 		#示例</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>(<span class="variable">@test</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2019</span><span class="number">-03</span><span class="number">-26</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br></pre></td></tr></table></figure>
<p>其他类似：time、year 、quarter、month、week、day、hour、minute、second</p>
<p>与时间相关<strong>函数</strong>：</p>
<p>名称作用CURDATE()返回当前日期CURTIME()返回当前时间MONTH(d)返回当前日期d中的月份值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CURDATE(),CURTIME(),<span class="keyword">MONTH</span>(birthday) <span class="keyword">AS</span> m <span class="keyword">FROM</span> <span class="keyword">table</span>; #birthday是列名，<span class="keyword">MONTH</span>(birthday)重命名为m</span><br><span class="line"><span class="keyword">select</span> curdate(),curtime() <span class="keyword">from</span> gongkuang limit <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h4 id="8-1-2-字符串函数"><a href="#8-1-2-字符串函数" class="headerlink" title="8.1.2 字符串函数"></a>8.1.2 字符串函数</h4><ul>
<li><code>CHAR_LENGTH(s)</code>计算字符串字符数</li>
<li><code>UPPER(s)</code>转为大写</li>
<li><code>LOWER(s)</code>转为小写</li>
<li><code>CONCAT(s1,s2...)</code>拼接多个字符串</li>
<li><code>LEFT(str,len)</code> <code>RIGHT(str,len)</code>返回字符串str 从左、右起len长的子串。</li>
<li><code>REVERSE(str)</code>把str倒序</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> uName,<span class="keyword">CHAR_LENGTH</span>(uName),<span class="built_in">UPPER</span>(uName) up,<span class="built_in">LOWER</span>(uName) low,concat(uName,<span class="built_in">upper</span>(uName)) <span class="keyword">FROM</span> t_u1;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p><img src="https://img-blog.csdnimg.cn/2019033114033833.PNG" alt="在这里插入图片描述"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> uName,<span class="keyword">left</span>(uName,<span class="number">2</span>),<span class="keyword">right</span>(uName,<span class="number">2</span>) <span class="keyword">from</span> t_u1;</span><br></pre></td></tr></table></figure>
<p>其他还有很多字符串函数可以需要的时候再查阅使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ASCII(str),</span><br><span class="line">BIN(N),</span><br><span class="line">CONV(str,from_base,to_base),</span><br><span class="line">ELT(N,str1,str2,str3,…),</span><br><span class="line">FIELD(str,str1,str2,str3,…),</span><br><span class="line">FIND_IN_SET(str,strlist),</span><br><span class="line">FORMAT(X,D),</span><br><span class="line"><span class="keyword">INSERT</span>(str,pos,len,newstr),</span><br><span class="line">LOCATE(substr,str,pos),</span><br><span class="line">REPLACE(str,from_str,to_str),</span><br><span class="line"><span class="built_in">POSITION</span>(substr <span class="keyword">IN</span> str),</span><br><span class="line">INSTR(str,substr),</span><br></pre></td></tr></table></figure>
<h4 id="8-1-3-数学函数"><a href="#8-1-3-数学函数" class="headerlink" title="8.1.3 数学函数"></a>8.1.3 数学函数</h4><ul>
<li><code>ABS(x)</code>绝对值</li>
<li><code>SQRT(x)</code>平方根</li>
<li><code>MOD(x，y)</code>求余</li>
<li><code>ROUND(X,Y)</code>X的Y位四舍五入小数</li>
<li><code>CEIL(x)</code>、<code>CEILING(x)</code>向上取整</li>
<li><code>FLOOR(x)</code>向下取整</li>
<li><code>POW(x,y)</code>、<code>POWER(x,y)</code>幂运算，求x的y次方幂</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> num,<span class="built_in">ABS</span>(num),<span class="built_in">SQRT</span>(num),<span class="built_in">MOD</span>(num,<span class="number">3</span>) <span class="keyword">from</span> t_t; #计算num列的绝对值和对<span class="number">3</span>求余</span><br></pre></td></tr></table></figure>
<h4 id="8-1-4-加密函数"><a href="#8-1-4-加密函数" class="headerlink" title="8.1.4 加密函数"></a>8.1.4 加密函数</h4><ul>
<li><code>PASSWORD(str)</code>对密码加密，不可逆</li>
<li><code>MD5(str)</code>、<code>SHA5()</code>MD5校验、SHA5校验</li>
<li><code>ENCODE(str，pswd_str)</code>加密字符串，结果必须用BLOB类型保存</li>
<li><code>DECODE(crypt_str,pswd_str)</code>解密字符串</li>
</ul>
<p>在插入数据的时候设置加密的格式、加密数据和加密解密的钥匙：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#t_t有id,birthday,uName,num,password,pp    其中pp是<span class="type">blob</span>类型</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_t <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;2018-11-11&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>,PASSWORD(<span class="string">&#x27;123456&#x27;</span>)); #password字段不是明文<span class="number">123456</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_t <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;2018-11-11&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>,MD5(<span class="string">&#x27;123456&#x27;</span>)); #password字段不是明文<span class="number">123456</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_t <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;2018-11-11&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>,MD5(<span class="string">&#x27;123456&#x27;</span>),ENCODE(<span class="string">&#x27;abcd&#x27;</span>,<span class="string">&#x27;aa&#x27;</span>)); #pp是明文abcd用aa加密得到的二进制</span><br><span class="line"><span class="keyword">SELECT</span> DECODE(pp,<span class="string">&#x27;aa&#x27;</span>) <span class="keyword">FROM</span> t_t <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>; #用aa解密pp 得到abcd</span><br></pre></td></tr></table></figure>
<h4 id="8-2-其他函数可以查阅mysql官方手册"><a href="#8-2-其他函数可以查阅mysql官方手册" class="headerlink" title="8.2 其他函数可以查阅mysql官方手册"></a>8.2 其他函数可以查阅mysql官方手册</h4><h2 id="9-存储过程"><a href="#9-存储过程" class="headerlink" title="9 存储过程"></a>9 存储过程</h2><h3 id="9-1-存储过程和函数定义"><a href="#9-1-存储过程和函数定义" class="headerlink" title="9.1 存储过程和函数定义"></a>9.1 存储过程和函数定义</h3><p>存储过程和函数是在数据库中定义一些 SQL 语句的集合，然后直接调用这些存储过程和函数来执行已经定义好的 SQL 语句。存储过程和函数可以避免开发人员重复的编写相同的 SQL 语句。而且，存储过程和函数是在 MySQL服务器中存储和执行的，可以减少客户端和服务器端的数据传输；</p>
<p>区别：</p>
<ul>
<li>存储函数必须有返回值，而存储过程没有，</li>
<li>存储过程的参数可以使用 in，out，inout 类型，而存储函数的参数只能是 in 类型的。</li>
<li>如果有函数从其他类型的数据库迁移到 MySQL，那么就可能因此需要将函数改造成存储过程</li>
</ul>
<h4 id="9-1-1-创建存储过程："><a href="#9-1-1-创建存储过程：" class="headerlink" title="9.1.1 创建存储过程："></a>9.1.1 创建存储过程：</h4><p>创建存储过程或函数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_name ([proc_parameter[,...]])</span><br><span class="line">    [characteristic ...] routine_body</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> sp_name ([func_parameter[,...]])</span><br><span class="line">    <span class="keyword">RETURNS</span> type</span><br><span class="line">    [characteristic ...] routine_body</span><br><span class="line"></span><br><span class="line">sp_name 参数是存储过程<span class="operator">/</span>或存储函数的名称</span><br><span class="line"></span><br><span class="line">proc_parameter 表示存储过程的参数列表，每个参数格式 [<span class="keyword">IN</span><span class="operator">|</span><span class="keyword">OUT</span><span class="operator">|</span><span class="keyword">INOUT</span>] param_name type</span><br><span class="line">    <span class="keyword">IN</span> 表示输入参数；<span class="keyword">OUT</span> 表示输出参数；<span class="keyword">INOUT</span> 表示既可以是输入，也可以是输出；param_name 参数是</span><br><span class="line">    存储过程的参数名称；type 参数指定存储过程的参数类型，该类型可以是 MySQL 数据库的任意数据类型</span><br><span class="line"></span><br><span class="line">func_parameter:param_name type</span><br><span class="line"></span><br><span class="line">type:<span class="keyword">Any</span> valid MySQL data type</span><br><span class="line"></span><br><span class="line">characteristic 参数指定存储过程的特性</span><br><span class="line">可取:LANGUAGE SQL| [NOT] DETERMINISTIC| &#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;| SQL SECURITY &#123; DEFINER | INVOKER &#125;| COMMENT &#x27;string&#x27;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">LANGUAGE</span> <span class="keyword">SQL</span>：说明 routine_body 部分是由 <span class="keyword">SQL</span> 语言的语句组成</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">NOT</span>] <span class="keyword">DETERMINISTIC</span>  存储过程输出结果是否是确定的，即每次输入一样输出也一样的程序，<span class="keyword">NOT</span> 每次输入一样但输出可能不一样</span><br><span class="line"></span><br><span class="line">    &#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;| SQL SECURITY &#123; DEFINER | INVOKER &#125; 指明子程序使用 SQL 语句的限制</span><br><span class="line">        <span class="operator">-</span> <span class="keyword">CONTAINS</span> <span class="keyword">SQL</span>子程序包含 <span class="keyword">SQL</span> 语句，但不包含读或写数据的语句。默认格式</span><br><span class="line">        <span class="operator">-</span> <span class="keyword">NO</span> <span class="keyword">SQL</span> 表示子程序中不包含 <span class="keyword">SQL</span>语句</span><br><span class="line">        <span class="operator">-</span> <span class="keyword">READS</span> <span class="keyword">SQL</span> DATA 子程序中包含读数据的语句</span><br><span class="line">        <span class="operator">-</span> <span class="keyword">MODIFIES</span> <span class="keyword">SQL</span> DATA 表示子程序中包含写数据的语句</span><br><span class="line"></span><br><span class="line">    SQL SECURITY &#123; DEFINER | INVOKER &#125;；指明谁有权限来执行。</span><br><span class="line">        <span class="operator">-</span> DEFINER 表示只有定义者自己才能够执行；</span><br><span class="line">        <span class="operator">-</span> INVOKER 表示调用者可以执行。默认情况下，系统指定的权限是 DEFINER。</span><br><span class="line"></span><br><span class="line">    COMMENT ‘string’ ：注释信息；</span><br><span class="line"></span><br><span class="line">routine_body 参数是 <span class="keyword">SQL</span> 代码的内容，可以用 BEGIN...END 来标志 <span class="keyword">SQL</span> 代码的开始和结束</span><br></pre></td></tr></table></figure>
<p>创建存储过程/函数示例sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_book ( <span class="keyword">IN</span> bT <span class="type">INT</span>,<span class="keyword">OUT</span> count_num <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">READS</span> <span class="keyword">SQL</span> DATA</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">         <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> t_book <span class="keyword">WHERE</span> bookTypeId<span class="operator">=</span>bT;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> pro_book(<span class="number">1</span>,<span class="variable">@total</span>); #调用存储过程</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> func_book (bookId <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">RETURN</span> ( <span class="keyword">SELECT</span> bookName <span class="keyword">FROM</span> t_book <span class="keyword">WHERE</span> id<span class="operator">=</span>bookId );</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> func_book(<span class="number">2</span>); #调用存储函数</span><br></pre></td></tr></table></figure>
<h4 id="9-1-2-修改存储过程或函数："><a href="#9-1-2-修改存储过程或函数：" class="headerlink" title="9.1.2 修改存储过程或函数："></a>9.1.2 修改存储过程或函数：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER &#123;PROCEDURE | FUNCTION&#125; sp_name [characteristic ...]</span><br><span class="line">#characteristic:参数含义类似</span><br></pre></td></tr></table></figure>
<h4 id="9-1-3-调用存储函数-过程"><a href="#9-1-3-调用存储函数-过程" class="headerlink" title="9.1.3 调用存储函数/过程"></a>9.1.3 调用存储函数/过程</h4><p>调用存储过程 <code>CALL sp_name([param_name[,...]);</code></p>
<p>调用存储函数 <code>sp_name([param_name[,...]);</code></p>
<h4 id="9-1-4-查看现有存储过程-函数"><a href="#9-1-4-查看现有存储过程-函数" class="headerlink" title="9.1.4 查看现有存储过程/函数"></a>9.1.4 查看现有存储过程/函数</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#SHOW &#123;PROCEDURE | FUNCTION&#125; STATUS [LIKE &#x27;pattern&#x27;] #查看状态</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;pro_book&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SHOW CREATE &#123;PROCEDURE | FUNCTION&#125; sp_name #查看定义</span><br></pre></td></tr></table></figure>
<h4 id="9-1-5-删除存储函数-过程"><a href="#9-1-5-删除存储函数-过程" class="headerlink" title="9.1.5 删除存储函数/过程"></a>9.1.5 删除存储函数/过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#DROP &#123;PROCEDURE | FUNCTION&#125; [IF EXISTS] sp_name</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> pro_user3;</span><br></pre></td></tr></table></figure>
<h3 id="9-2-存储函数变量"><a href="#9-2-存储函数变量" class="headerlink" title="9.2 存储函数变量"></a>9.2 存储函数变量</h3><h4 id="9-2-1-存储函数-过程中定义变量"><a href="#9-2-1-存储函数-过程中定义变量" class="headerlink" title="9.2.1 存储函数/过程中定义变量"></a>9.2.1 存储函数/过程中定义变量</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> var_name[,...] type [<span class="keyword">DEFAULT</span> <span class="keyword">value</span>]</span><br></pre></td></tr></table></figure>
<p>定义的变量不赋值时默认插入为NULL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#t_user有id,uName,password</span><br><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> a,b <span class="type">VARCHAR</span>(<span class="number">20</span>) ;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,a,b);</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> pro_user(); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-2-2-存储函数过程变量赋值"><a href="#9-2-2-存储函数过程变量赋值" class="headerlink" title="9.2.2 存储函数过程变量赋值"></a>9.2.2 存储函数过程变量赋值</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">1</span> 直接赋值</span><br><span class="line"><span class="keyword">SET</span> var_name <span class="operator">=</span> expr [, var_name <span class="operator">=</span> expr] ...</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span> 从其他表查询结果赋给当前表</span><br><span class="line"><span class="keyword">SELECT</span> col_name[,...] <span class="keyword">INTO</span> var_name[,...] table_expr</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#分别表示直接赋值和查询结果赋值</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user2()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> a,b <span class="type">VARCHAR</span>(<span class="number">20</span>) ;</span><br><span class="line">        <span class="keyword">SET</span> a<span class="operator">=</span><span class="string">&#x27;java1234&#x27;</span>,b<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,a,b);</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> pro_user2(); #调用存储过程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#t_user2有id,uName,password  从t_user2查询数据存入变量再插入到t_user</span><br><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user3()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> a,b <span class="type">VARCHAR</span>(<span class="number">20</span>) ;</span><br><span class="line">        <span class="keyword">SELECT</span> userName2,password2 <span class="keyword">INTO</span> a,b <span class="keyword">FROM</span> t_user2 <span class="keyword">WHERE</span> id2<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,a,b);</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> pro_user3(); #调用存储过程</span><br></pre></td></tr></table></figure>
<h3 id="9-3-游标"><a href="#9-3-游标" class="headerlink" title="9.3 游标"></a>9.3 游标</h3><p>查询语句可能查询出多条记录，在存储过程和函数中使用游标来逐条读取查询结果集中的记录。游标必须声明在处理程序之前，并且声明在变量和条件之后。</p>
<p>游标的使用包括</p>
<ul>
<li>声明游标 <code>DECLARE cursor_name CURSOR FOR select_statement ;</code></li>
<li>打开游标 <code>OPEN cursor_name;</code></li>
<li>使用游标 <code>FETCH cursor_name INTO var_name [,var_name ... ];</code></li>
<li>关闭游标 <code>CLOSE cursor_name;</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user4()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> a,b <span class="type">VARCHAR</span>(<span class="number">20</span>) ;</span><br><span class="line">        <span class="keyword">DECLARE</span> cur_t_user2 <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> userName2,password2 <span class="keyword">FROM</span> t_user2;</span><br><span class="line">        <span class="keyword">OPEN</span> cur_t_user2;</span><br><span class="line">        <span class="keyword">FETCH</span> cur_t_user2 <span class="keyword">INTO</span> a,b; #未使用循环，所以只取出、插入了集合的一条数据</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,a,b);</span><br><span class="line">        <span class="keyword">CLOSE</span> cur_t_user2;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> pro_user4(); #调用存储过程</span><br></pre></td></tr></table></figure>
<h3 id="9-4-流程控制"><a href="#9-4-流程控制" class="headerlink" title="9.4 流程控制"></a>9.4 流程控制</h3><p>存储过程和函数中可以使用流程控制来控制语句的执行。MySQL 中可以使用 IF 语句、CASE 语句、LOOP语句、LEAVE 语句、ITERATE 语句、REPEAT 语句和 WHILE 语句来进行流程控制。</p>
<h4 id="9-4-1-IF语句"><a href="#9-4-1-IF语句" class="headerlink" title="9.4. 1 IF语句"></a>9.4. 1 IF语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF search_condition <span class="keyword">THEN</span> statement_list</span><br><span class="line">[ELSEIF search_condition <span class="keyword">THEN</span> statement_list ]...</span><br><span class="line">[<span class="keyword">ELSE</span> statement_list ]</span><br><span class="line"><span class="keyword">END</span> IF</span><br></pre></td></tr></table></figure>
<p>举例：根据传入的id查询，结果数量大于0时更新这个id对应的name，否则新插入一条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user5(<span class="keyword">IN</span> bookId <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> <span class="variable">@num</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> id<span class="operator">=</span>bookId; #<span class="variable">@num</span> 表示全局变量</span><br><span class="line">        IF <span class="variable">@num</span><span class="operator">&gt;</span><span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> userName<span class="operator">=</span><span class="string">&#x27;java12345&#x27;</span> <span class="keyword">WHERE</span> id<span class="operator">=</span>bookId;</span><br><span class="line">        <span class="keyword">ELSE</span></span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">        <span class="keyword">END</span> IF ;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> pro_user5(<span class="number">4</span>); #调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> pro_user5(<span class="number">5</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-4-2-CASE-语句"><a href="#9-4-2-CASE-语句" class="headerlink" title="9.4. 2 CASE 语句"></a>9.4. 2 CASE 语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CASE</span> case_value</span><br><span class="line"><span class="keyword">WHEN</span> when_value <span class="keyword">THEN</span> statement_list</span><br><span class="line">[<span class="keyword">WHEN</span> when_value <span class="keyword">THEN</span> statement_list]...</span><br><span class="line">[<span class="keyword">ELSE</span> statement_list ]</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span></span><br></pre></td></tr></table></figure>
<p>举例：传入id，查询的结果数量为1时更新，2时插入，其他情况插入另一条</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user6(<span class="keyword">IN</span> bookId <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> <span class="variable">@num</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> id<span class="operator">=</span>bookId;</span><br><span class="line">        <span class="keyword">CASE</span> <span class="variable">@num</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> userName<span class="operator">=</span><span class="string">&#x27;java12345&#x27;</span> <span class="keyword">WHERE</span> id<span class="operator">=</span>bookId;</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">        <span class="keyword">ELSE</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(<span class="keyword">NULL</span>,<span class="string">&#x27;231231221321312&#x27;</span>,<span class="string">&#x27;2321312321312&#x27;</span>);</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">CASE</span> ;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> pro_user6(<span class="number">5</span>); #调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> pro_user6(<span class="number">6</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-4-3-LOOP，LEAVE-语句"><a href="#9-4-3-LOOP，LEAVE-语句" class="headerlink" title="9.4. 3 LOOP，LEAVE 语句"></a>9.4. 3 LOOP，LEAVE 语句</h4><p>LOOP 语句可以使某些特定的语句重复执行，实现一个简单的循环。但是 LOOP 语句本身没有停止循环的语句，必须是遇到 LEAVE 语句等才能停止循环。LOOP 语句的语法的基本形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[begin_label：]LOOP</span><br><span class="line">    Statement_list</span><br><span class="line"><span class="keyword">END</span> LOOP [ end_label ]</span><br></pre></td></tr></table></figure>
<p>LEAVE 语句主要用于跳出循环控制。语法形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LEAVE label</span><br></pre></td></tr></table></figure>
<p>举例：循环插入指定参数条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user7(<span class="keyword">IN</span> totalNum <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        aaa:LOOP</span><br><span class="line">            <span class="keyword">SET</span> totalNum<span class="operator">=</span>totalNum<span class="number">-1</span>;</span><br><span class="line">            IF totalNum<span class="operator">=</span><span class="number">0</span> <span class="keyword">THEN</span> LEAVE aaa ;</span><br><span class="line">            <span class="keyword">ELSE</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(totalNum,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">            <span class="keyword">END</span> IF ;</span><br><span class="line">        <span class="keyword">END</span> LOOP aaa ;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user;</span><br><span class="line"><span class="keyword">CALL</span> pro_user7(<span class="number">11</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-4-4-ITERATE-语句"><a href="#9-4-4-ITERATE-语句" class="headerlink" title="9.4. 4 ITERATE 语句"></a>9.4. 4 ITERATE 语句</h4><p>ITERATE 语句也是用来跳出循环的语句。但是，ITERATE 语句是跳出本次循环，然后直接进入下一次循环。基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label ;</span><br></pre></td></tr></table></figure>
<p>示例：指定插入次数参数为3的时候不插入，其余在0之前的都插入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user8(<span class="keyword">IN</span> totalNum <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        aaa:LOOP</span><br><span class="line">            <span class="keyword">SET</span> totalNum<span class="operator">=</span>totalNum<span class="number">-1</span>;</span><br><span class="line">            IF totalNum<span class="operator">=</span><span class="number">0</span> <span class="keyword">THEN</span> LEAVE aaa ;</span><br><span class="line">            ELSEIF totalNum<span class="operator">=</span><span class="number">3</span> <span class="keyword">THEN</span> ITERATE aaa ; #当是<span class="number">3</span>时，直接continue</span><br><span class="line">            <span class="keyword">END</span> IF ;</span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(totalNum,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">        <span class="keyword">END</span> LOOP aaa ;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user;</span><br><span class="line"><span class="keyword">CALL</span> pro_user8(<span class="number">11</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-4-5-REPEAT-语句"><a href="#9-4-5-REPEAT-语句" class="headerlink" title="9.4. 5 REPEAT 语句"></a>9.4. 5 REPEAT 语句</h4><p>REPEAT 语句是有条件控制的循环语句。当满足特定条件时，就会跳出循环语句。REPEAT 语句的基本语法形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ begin_label : ] REPEAT</span><br><span class="line">    Statement_list</span><br><span class="line">    UNTIL search_condition</span><br><span class="line"><span class="keyword">END</span> REPEAT [ end_label ]</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user9(<span class="keyword">IN</span> totalNum <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        REPEAT</span><br><span class="line">            <span class="keyword">SET</span> totalNum<span class="operator">=</span>totalNum<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(totalNum,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">            UNTIL totalNum<span class="operator">=</span><span class="number">1</span></span><br><span class="line">        <span class="keyword">END</span> REPEAT;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user;</span><br><span class="line"><span class="keyword">CALL</span> pro_user9(<span class="number">11</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h4 id="9-4-6-WHILE-语句"><a href="#9-4-6-WHILE-语句" class="headerlink" title="9.4. 6 WHILE 语句"></a>9.4. 6 WHILE 语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ begin_label : ] WHILE search_condition DO</span><br><span class="line">    Statement_list</span><br><span class="line"><span class="keyword">END</span> WHILE [ end_label ]</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">&amp;&amp;</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> pro_user10(<span class="keyword">IN</span> totalNum <span class="type">INT</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        WHILE totalNum<span class="operator">&gt;</span><span class="number">0</span> DO</span><br><span class="line">            <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user <span class="keyword">VALUES</span>(totalNum,<span class="string">&#x27;2312312&#x27;</span>,<span class="string">&#x27;2321312&#x27;</span>);</span><br><span class="line">            <span class="keyword">SET</span> totalNum<span class="operator">=</span>totalNum<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">END</span> WHILE ;</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="operator">&amp;&amp;</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user;</span><br><span class="line"><span class="keyword">CALL</span> pro_user10(<span class="number">11</span>); #调用存储过程</span><br></pre></td></tr></table></figure>
<h2 id="10-数据备份与还原"><a href="#10-数据备份与还原" class="headerlink" title="10 数据备份与还原"></a>10 数据备份与还原</h2><p>备份数据可以保证数据库中数据的安全，需要定期的进行数据库备份，可以备份数据表和整个数据库。</p>
<h3 id="10-1-使用-mysqldump-备份（导出）"><a href="#10-1-使用-mysqldump-备份（导出）" class="headerlink" title="10.1 使用 mysqldump 备份（导出）"></a>10.1 使用 mysqldump 备份（导出）</h3><p>可以使用命令备份，也可以使用图形管理工具直接导出备份。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -username -p dbname table1 table2 ... &gt; BackupName.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>dbname ：表示数据库的名称；</li>
<li>table1 和 table2 ：表示数据表的名称，没有指明时将备份整个数据库；</li>
<li>BackupName.sql ：表示备份文件的名称，文件名前面可以加绝对路径，一般以sql做后缀</li>
</ul>
<h3 id="10-2-还原（导入sql数据）"><a href="#10-2-还原（导入sql数据）" class="headerlink" title="10.2 还原（导入sql数据）"></a>10.2 还原（导入sql数据）</h3><p>使用命令或者图形界面导入还原数据。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p [dbname] &lt; backup.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>dbname ：表示导入后的数据库名称，参数可指定或不指定</li>
<li>指定数据库名时，表示还原文件到这个表下</li>
<li>不指定数据库名时，表示还原备份sql文件中默认的数据库和表属性。</li>
</ul>

        
    </section>
</article>




<nav class="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
</nav>



            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    

</body>
</html>
